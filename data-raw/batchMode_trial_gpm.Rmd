---
title: "PK object batch mode trial"
author: "Gilberto Padilla Mercado"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
set.seed(2023)
library(tidyverse, quietly = TRUE)
devtools::load_all() # Loads the invivopkfit package in feature/pkS3obj_facet branch
tidyverse_conflicts()
```

## Working with one DTXSID + Species combination

The first step is understanding how to work with a single DTXSID + Species combination.
Once we know how to do this, it will be easier to apply it to (potentially)
a list of these objects in a vectorized fashion.
Here I subset the `cvt` object and use that as my working data.

```{r data_loading}
# There are 103 unique chemicals in this object
cvt %>% pull(chemicals_analyzed.dsstox_substance_id) %>%
  unique() %>%
  length()

my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% c("DTXSID0020442",
                                                              "DTXSID5032600",
                                                              "DTXSID2021103"))
my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% "DTXSID9021924")

my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% "DTXSID2021103")
# Opt params not found ERROR
# 
# 


my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% c("DTXSID2039336",
                                                              "DTXSID7029904",
                                                              "DTXSID1021087",
                                                              "DTXSID2020682"))

```

Next, I want to follow the steps required for the particular analysis I would like.
In this instance, I set the optimizer to "L-BFGS-B" and dose-normalize the output.
I do not scale the time or log-transform the concentration values.
Since I would like to do a "Pooled" analysis,
I set the `error_group = vars(Chemical, Species)`.

```{r single_fit}
# Pooled
my_pk <- pk(data = my_predata) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species)) 
# Add Reference for Joint Analysis

my_pk <- do_preprocess(my_pk)

my_pk <- do_data_info(my_pk)
# summarizes error (Returning more or less than 1 row per summarize)

my_pk <- do_prefit(my_pk)


my_pk <- do_fit(my_pk)


# Joint
my_pk <- pk(data = cvt) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species, Reference)) 
# Add Reference for Joint Analysis

my_pk <- do_preprocess(my_pk)

my_pk <- do_data_info(my_pk) 
# summarizes error (Returning more or less than 1 row per summarize)

my_pk <- do_prefit(my_pk)


my_pk <- do_fit(my_pk)
```

Batch mode works! Now, I have updated the `coef`, `predict`, `rmse`, and `residuals`
methods.

```{r after_method_update}
# Changed pk_methods coef() and predict() to those above
# Ran the following after making the pk object:
devtools::load_all()
all_my_data <- my_pk$data # following the full dataset to prefit
my_pk$data %>% filter(Chemical == "DTXSID2021103")

my_coefs_update <- coef(my_pk, drop_sigma = TRUE)
my_pred_update <- predict(my_pk,
                          exclude = TRUE, # add the "exclude" column to output
                          use_scale_conc = TRUE)

predict(my_pk,
        exclude = TRUE, # add the "exclude" column to output
        use_scale_conc = TRUE)


my_pred2 <- predict(my_pk,
                    newdata = data.frame(Chemical = "DTXSID2021731",
                                         Species = "rat",
                                         Route = "iv",
                                         Media = "plasma",
                                         Dose = 20,
                                         Time = 1.6,
                                         Time.Units = "hours"),
                    exclude = FALSE,
                    use_scale_conc = FALSE)

rmse(my_pk) %>% View("RMSE_test")
residuals(my_pk) %>% View("Residuals_test")

```


```{r plotting_method}


plot(my_pk, use_scale_conc = TRUE,
     print_out = TRUE, log10_C = FALSE)

my_plot <- plot(my_pk, use_scale_conc = TRUE)

# This is printable into a one file, multipage pdf
pdf(file = "C:/Users/GPADILLA/OneDrive - Environmental Protection Agency (EPA)/Profile/Documents/Code Notes/plotMethod_freeY.pdf",
    width = 10,
    height = 8)
plot(my_pk, use_scale_conc = TRUE,
     print_out = TRUE)
dev.off()

png(file = "C:/Users/GPADILLA/OneDrive - Environmental Protection Agency (EPA)/Profile/Documents/Code Notes/examplePlot.png",
    width = 8,
    height = 6,
    units = "in",
    res = 150,
    type = "cairo",
    antialias = "none")
plot(my_pk, use_scale_conc = TRUE,
     method = "L-BFGS-B",
     print_out = TRUE)[[3]]
dev.off()


```

```{r get_tkstats_logLik_methods}
my_tkstats <- get_tkstats(my_pk)

names(my_tkstats)
my_tkstats


my_logLike_update <- logLik(my_pk)




```


```{r remaining_methods}
# coef_sd

devtools::load_all()
AIC(my_pk2) %>% View()
BIC(my_pk)

get_winning_model(my_pk)
eval_tkstats(my_pk)

```

The purpose of the following code is to generate data.frames with information for
all 103 chemicals in the `cvt` dataset that comes with `invivopkfit`.
I will need to do append each dataframe to the last for the outputs of the following
methods:

- `AIC()`
- `BIC()` left-joined with `AIC` output
- `get_tkstats()`

I will also have to fit these iteratively and manage the memory as part of the loop.


```{r allDTXSIDs_analysis}

# after fitting pk object for all cvt objects
# saveRDS(my_pk, file = "data-raw/all_cvt_pk.rds")
# saveRDS(my_pk, file = "data-raw/all_cvt_pk_JOINT.rds")
my_pk <- readRDS("data-raw/all_cvt_pk.rds")
my_AIC <- AIC(my_pk)
my_tkstats <- get_tkstats(my_pk)
my_IC <- left_join(AIC(my_pk), BIC(my_pk))

my_IC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "bobyqa") %>%
  ungroup() %>%
  count(model)
# model_1comp 59
# model_2comp 50
# model_flat   2

my_IC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "L-BFGS-B") %>%
  ungroup() %>%
  # filter(model == "model_flat") %>% pull(Chemical) %>% unique()
  count(model)
# model_1comp 57
# model_2comp 50
# model_flat   4

all_my_data <- my_pk$data
all_my_data %>%
  group_by(Chemical,
           Species,
           Reference,
           Route,
           Dose, Time) %>%
  filter(n() > 1,
         sum(is.na(Conc)) != n(),
         LOQ < Conc) %>%
  mutate(meanConc = mean(Conc, na.rm = TRUE)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(foldConc = Conc / meanConc) %>%
  count(foldConc > 2)
# 88.4% inside twofold
# 2.4%  above twofold
# 9.2%  below twofold

all_my_data %>%
  group_by(Chemical,
           Species,
           Reference,
           Route,
           Dose, Time) %>%
  filter(n() > 1,
         sum(is.na(Conc)) != n(),
         LOQ < Conc) %>%
  mutate(meanConc = mean(Conc, na.rm = TRUE)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(foldConc = Conc / meanConc) %>%
  ggplot(aes(x = foldConc)) +
  geom_histogram(binwidth = 0.1,
                 fill = "grey5") +
  coord_cartesian(xlim =  c(0, 4),
                  ylim = c(0, 2000)) +
  scale_y_continuous(expand = c(0, 0)) +
  expand_limits(y = 0) +
  geom_vline(xintercept = c(0.5, 2), color = "red3", linetype = "dashed") +
  annotate(geom= "text",
           x = 1.25, y = 1800,
           label = "88.4% of Observations\n within a factor of 2") +
  theme_classic() +
  labs(x = "Concentration Normalized to Average",
                y = "Number of Observations") +
  theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.4))

ggsave(paste0("C:/Users/GPADILLA/OneDrive - Environmental Protection Agency (EPA)/Profile/Documents/Figures/",
              "NormalizedConcentrations_2023-07-11.png"),
       height = 3.5,
       width = 5.5,
       units = "in")


all_my_data %>%
  group_by(Chemical,
           Species,
           Reference,
           Route,
           Dose, Time) %>%
  filter(n() > 1,
         sum(is.na(Conc)) != n(),
         exclude == FALSE) %>%
  mutate(meanConc = mean(Conc, na.rm = TRUE)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(foldConc = Conc / meanConc) %>%
  inner_join(my_tkstats %>%
              dplyr::select(Chemical, Species,
                            Route, Media,
                            tmax) %>%
              filter(!is.na(tmax))) %>%
  group_by(Chemical,
           Species,
           Reference,
           Route,
           Media,
           Dose) %>%
  mutate(
         normTime = ifelse(
           Route == "iv",
           1 + Time/max(Time),
           ifelse(
             Time > tmax,
             ((Time - tmax)/max(Time)) + 1,
             0.5 + Time/(2*tmax)
           )
         )) %>%
  ggplot(aes(
    x = normTime,
    y = foldConc
  )) +
  geom_point(alpha = 0.2) +
  geom_vline(xintercept = 1, color = "blue", linetype = "dashed") +
  geom_vline(xintercept = 2, color = "green4", linetype = "dashed") +
  geom_hline(yintercept = c(0.5, 2), color = "red3", linetype = "dashed") +
  facet_grid(cols = vars(Route),
             scales = "free_x") +
  labs(x = "ADME-Normalized Time",
       y = "Mean-Normalized Concentration") +
  theme(aspect.ratio = 1,
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text.x = element_blank())

ggsave(paste0("C:/Users/GPADILLA/",
              "OneDrive - Environmental Protection Agency (EPA)/",
              "Profile/Documents/Figures/",
              "ADME_NormalizedTime-NormalizedConcentrations_2023-07-19.png"),
       height = 4,
       width = 6,
       units = "in")

my_tkstats %>%
              dplyr::select(Chemical, Species,
                            Route, Media, model, method,
                            tmax) %>%
              filter(!is.na(tmax))

all_my_data %>%
              dplyr::select(Chemical, Species,
                            Route, Media, Dose,
                            Reference) %>%
  distinct() %>% nrow()

my_preds <- predict(my_pk,
                    use_scale_conc = TRUE)

winmodels <- my_IC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "L-BFGS-B") %>%
  ungroup() %>%
  dplyr::select(Chemical, Species,
                method, model)

my_preds <- inner_join(winmodels, my_preds)
my_tkstats <- inner_join(winmodels, my_tkstats) %>%
  dplyr::select(-TKstats) %>% distinct()
my_nca <- get_nca(my_pk,
                  nca_group = vars(Chemical, Species,))
my_nca <- my_nca %>% dplyr::select(-param_sd_z, -param_units) %>%
  pivot_wider(names_from = param_name,
              values_from = param_value)

# Saving some CSVs
# my_tkstats %>% write_csv(file = "data-raw/Pooled_TKstats.csv")
# my_nca %>% write_csv(file = "data-raw/NonCompartmentalAnalysis.csv")
# Loading CSVs
my_nca <- read_csv(file = "data-raw/NonCompartmentalAnalysis.csv")

my_preds %>%
  rowwise() %>%
  mutate(Pred_Obs = Conc_trans/Conc_est) %>%
  filter(is.finite(Pred_Obs),
         model %in% c("model_1comp", "model_2comp")) %>%
  # mutate(pass = ifelse(Pred_Obs < 0.5, TRUE, FALSE)) %>%
  # pull(pass) %>% table()
  ggplot(aes(x = Pred_Obs)) +
  geom_histogram(binwidth = 0.4,
                 fill = "grey5") +
  scale_x_log10(limits = c(NA, 1E6)) +
  expand_limits(y = 0) +
  geom_vline(xintercept = c(0.5, 2), color = "red3", linetype = "dashed") +
  facet_grid(cols = vars(model),
             rows = vars(Route)) +
  labs(x = "Predicted/Observed",
       y = "Number of Observations") +
  theme_classic() +
  theme(aspect.ratio = 1,
        panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.4))

# 91.1% of Pred_Obs are finite
# 16.6% Are below two-fold
# 33.2%  Are above two-fold
# 50.2% Are within twofold

ggsave(paste0("C:/Users/GPADILLA/",
              "OneDrive - Environmental Protection Agency (EPA)/",
              "Profile/Documents/Figures/",
              "PredictedObserved_compartmentModels_2023-07-11.png"),
       height = 6, width = 7)


# Pooled analysis
all_my_data %>% group_by(Chemical, Species, Reference, Media, Route) %>%
  filter(is.finite(Conc)) %>%
  summarise(OOM = log10(max(Conc) / min(Conc))) %>% 
  ggplot(aes(x = OOM)) +
  geom_histogram(bins = 15,
                 color = NA,
                 fill = "grey5") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  scale_x_continuous(breaks = c(0, 1, 2, 3, 4, 5)) +
  labs(x = "Orders of Magnitude per Series\n log10(max/min)",
       y = "Count") +
  theme(aspect.ratio = 1,
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        axis.ticks = element_blank(),
        axis.line = element_blank())

ggsave(paste0("C:/Users/GPADILLA/",
              "OneDrive - Environmental Protection Agency (EPA)/",
              "Profile/Documents/Figures/",
              "OrdersOfMagnitude_2023-07-12.png"),
       height = 4, width = 4)

my_pk$prefit$fit_check %>% filter(fit_decision == "abort") %>%
  dplyr::select(model, Chemical) %>% distinct()

all_my_data %>%
  filter(Chemical == "DTXSID2021781")

```


```{r update_eval_tkstats}
devtools::load_all()
my_pk <- readRDS("data-raw/all_cvt_pk.rds")
my_eval <- eval_tkstats(my_pk)

# To give summary RMSEs of Cmax and AUC...
my_eval <- my_eval %>%
  group_by(method, model, .add = TRUE) %>%
  ungroup(Reference) %>%
  summarize(AUC_inf_RMSE = sqrt((1/n())*(sum(AUC_inf.tkstats - AUC_inf.nca,
                                             na.rm = TRUE)^2)),
            Cmax_RMSE = sqrt((1/n())*(sum(Cmax.tkstats - Cmax.nca,
                                          na.rm = TRUE)^2)),
            .groups = "keep")

my_eval <- my_eval %>%
  mutate(dose_norm = TRUE,
         log10_norm = FALSE,
         scale_time = FALSE,
         Analysis_Type = "Pooled")


ggplot(my_eval,
       aes(x = AUC_inf_RMSE,
           y = Cmax_RMSE)) +
  geom_point() +
  geom_abline(slope = 1) +
  scale_y_log10() +
  scale_x_log10()

ggplot(my_eval,
       aes(x = -log10(AUC_inf_RMSE))) +
  geom_histogram(fill = "grey5") +
  facet_grid(cols = vars(method)) +
  labs(x = "Accuracy of AUC",
       y = "Observations") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        axis.ticks = element_blank(),
        axis.line = element_blank())


```


```{r eval_Joint}
my_pk2 <- readRDS("data-raw/all_cvt_pk_JOINT.rds")
my_eval_joint <- eval_tkstats(my_pk2)

# To give summary RMSEs of Cmax and AUC...
my_eval_joint <- my_eval_joint %>%
  group_by(method, model, .add = TRUE) %>%
  ungroup(Reference) %>%
  summarize(AUC_inf_RMSE = sqrt((1/n())*(sum(AUC_inf.tkstats - AUC_inf.nca,
                                             na.rm = TRUE)^2)),
            Cmax_RMSE = sqrt((1/n())*(sum(Cmax.tkstats - Cmax.nca,
                                          na.rm = TRUE)^2)),
            .groups = "keep")

my_eval_joint <- my_eval_joint %>%
  mutate(dose_norm = TRUE,
         log10_norm = FALSE,
         scale_time = FALSE,
         Analysis_Type = "Joint")


ggplot(my_eval_joint,
       aes(x = AUC_inf_RMSE,
           y = Cmax_RMSE)) +
  geom_point()

ggplot(my_eval_joint,
       aes(x = -log10(AUC_inf_RMSE))) +
  geom_histogram(fill = "grey5") +
  facet_grid(cols = vars(method)) +
  labs(x = "Accuracy of AUC",
       y = "Observations") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        axis.ticks = element_blank(),
        axis.line = element_blank())


total_eval <- bind_rows(my_eval, my_eval_joint)

ggplot(total_eval,
       aes(x = AUC_inf_RMSE,
           y = Cmax_RMSE)) +
  geom_point() +
  facet_grid(rows = vars(Analysis_Type))

total_eval %>%
  dplyr::select(!Cmax_RMSE) %>%
  pivot_wider(names_from = Analysis_Type,
              values_from = AUC_inf_RMSE) %>%
  ggplot(aes(x = log10(Pooled),
             y = log10(Joint),
             color = Media)) +
  geom_point(alpha = 0.3) +
  geom_abline(slope = 1, linetype = "dashed") +
  facet_grid(rows = vars(model),
             cols = vars(method)) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        axis.ticks = element_blank(),
        axis.line = element_blank())


total_eval %>%
  dplyr::select(!Cmax_RMSE) %>%
  pivot_wider(names_from = Analysis_Type,
              values_from = AUC_inf_RMSE) %>%
  mutate(ratio = Joint/Pooled) %>%
  # filter(!(ratio == 1)) %>% 
  # View()
  pull(Chemical) %>%
  # unique()
  length()

```

