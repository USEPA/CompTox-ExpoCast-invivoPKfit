---
title: "cvt_fitting"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cvt_fitting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(invivoPKfit)
devtools::load_all()
```


```{r mininal-pk}
cvt_df <- subset(cvt, analyte_dtxsid %in% c("DTXSID8031865",
                                            "DTXSID5032498",
                                            "DTXSID0020442"))

minimal_pk <- pk(data = cvt_df)
```



# "Joint" analysis
This type of analysis fits each Chemical and Species data group but uses the
standard deviations from each Chemical, Species, Reference group to model error.


## Test preprocessing data

```{r}
joint_pk <- minimal_pk +
  facet_data(ggplot2::vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = FALSE,
                      suppress.messages = FALSE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = FALSE, log10_trans = TRUE) +
  stat_error_model(error_group = vars(Chemical, Species, Reference)) 

joint_pk <- do_preprocess(joint_pk)
```

## Test data summary

```{r}
joint_pk <- do_data_info(joint_pk)
```

## Test pre-fit

```{r}
joint_pk <- do_prefit(joint_pk)
```

## Test fit

```{r}
joint_pk <- do_fit(joint_pk)
```


# "Pooled" analysis
This analysis takes all the Chemical and Species data together and models
the error of all the data during fitting.

```{r}
pooled_pk <- minimal_pk +
  facet_data(ggplot2::vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE,
                      suppress.messages = TRUE) +
  settings_optimx(method = c("L-BFGS-B")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  stat_error_model(error_group = vars(Chemical, Species)) 

pooled_pk <- do_fit(pooled_pk)
```

# "Separate" analysis
This analysis takes all the Chemical, Species, and Reference data individually
and models the error similarly.

```{r}
separate_pk <- minimal_pk +
  facet_data(ggplot2::vars(Chemical, Species, Reference)) +
  settings_preprocess(keep_data_original = FALSE,
                      suppress.messages = TRUE) +
  settings_optimx(method = c("L-BFGS-B")) +
  scale_conc(dose_norm = FALSE, log10_trans = FALSE) +
  scale_time(new_units = "auto") +
  stat_error_model(error_group = vars(Chemical, Species, Reference)) 

separate_pk <- do_fit(separate_pk)
```

