---
title: "Clearance Project - 3 - TKstats"
author: "Gilberto Padilla Mercado"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r library-loading}
today <- format(Sys.Date(), "%d%b%Y")
devtools::load_all()
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(ctxR)
library(ggdist)
library(patchwork)
```

```{r data-loading}
this_pk <- readRDS("data-raw/plasma_CvTfits.rds")
load("data-raw/chem_lists.RData")
load("data-raw/plasma_CvTfits_data.RData")
load("data-raw/rat_pars_human.RData")
all_chem_properties <- readRDS("data-raw/ctxR_3comp2_cheminfo.rds")
full_pk <- readRDS("data-raw/all_cvt_pk.rds")
full_tkstats <- get_tkstats(full_pk)
```

```{r combination-function}
# Only need a simple bootstrapping method
combo_gen_splitter <- function(df, num = 1000L) {
  # Checks
  num = as.integer(num)
  stopifnot(
    is.data.frame(df),
    !is.na(num)
  )
  
  start <- 100L
  end <- 100L+num
  seed_seq <- seq.int(start, end)
  full_df_combos <- lapply(
    seed_seq,
    \(x) {
      set.seed(x)
      sample_df <- df %>%
        group_by(Chemical, Species, Reference, Route, Media, Dose, Time) %>%
        slice_sample(prop = 1, replace = TRUE) %>%
        ungroup()
      return(sample_df)
    }
  )
  
  
  message(paste("Samples: ", num))
  set.seed(NULL)
  invisible(full_df_combos)
}


```

```{r example_chemical}
# Using the example chemical
trial_coefsd <- coef_sd(full_pk)
trial_coefsd_reduced <- trial_coefsd %>% 
  filter(param_name %in% c("kelim", "Vdist", "V1")) %>%
  distinct()

trial_coefsd_reduced %>%
  filter(is.na(param_sd), model == "model_1comp") %>%
  distinct(Chemical, Species) -> selected_trial


test_chem_data <- get_data(full_pk) %>% filter(Conc > pLOQ) %>%
  count(Chemical, Species, Reference, Route, Media, Dose, Time) %>% arrange(-n) %>%
  filter(n > 4) %>%
  inner_join(selected_trial) %>%
  distinct(Chemical, Species, Reference, Route, Media, Dose) %>%
  inner_join(get_data(full_pk))

# Make 1000 sample data sets
system.time(
  test_chem_data_listsplits <- combo_gen_splitter(test_chem_data)
)

# Takes way too long, parallelize it

clust <- parallel::makeCluster(parallel::detectCores()-4L)
parallel::clusterCall(clust, function() devtools::load_all())
system.time(
  Css_list <- parallel::parLapply(
    clust,
    test_chem_data_listsplits,
    \(x) {
      tmp_pk <- pk(x,
                   mapping = ggplot2::aes(
                     Chemical = Chemical,
                     Chemical_Name = Chemical_Name,
                     DTXSID = DTXSID,
                     CASRN = CASRN,
                     Species = Species,
                     Reference = Reference,
                     Media = Media,
                     Route = Route,
                     Dose = Dose,
                     Dose.Units = "mg/kg",
                     Subject_ID = Subject_ID,
                     Series_ID = Series_ID,
                     Study_ID = Study_ID,
                     ConcTime_ID = ConcTime_ID,
                     N_Subjects = N_Subjects,
                     Weight = Weight,
                     Weight.Units = "kg",
                     Time = Time,
                     Time.Units = "hours",
                     Value = Value,
                     Value.Units = "mg/L",
                     Value_SD = Value_SD,
                     LOQ = LOQ
                   )
      ) +
        scale_conc(dose_norm = TRUE,
                   log10_trans = TRUE) +
        settings_optimx(method = c(
          "bobyqa"
        ))
      
      tmp_pk <- do_fit(tmp_pk)
      tmp_tkstats <- get_tkstats(tmp_pk) %>%
        distinct(Chemical, Species, Reference,
                 Route, Media,
                 model, method,
                 Css, CLtot, halflife)
      
      return(tmp_tkstats)
    })
)
parallel::stopCluster(clust)

Css_df_full <- bind_rows(Css_list)

```


```{r plotting-bootstraps}
num_samples <- length(Css_list)

test_chem_full_tkstats <- full_tkstats %>%
  filter(model != "model_flat") %>%
  inner_join(selected_trial) %>%
  distinct(Chemical, Species, model, Css)



Css_df_full %>%
  filter(model != "model_flat") %>%
  left_join(this_winmodel %>% 
              mutate(winmodel = TRUE) %>%
              select(-c(near_flat, preds_below_loq))) %>% 
  mutate(winmodel = ifelse(is.na(winmodel), FALSE, winmodel)) %>%
  ggplot(aes(x = halflife, y = Chemical, fill = winmodel)) +
  stat_slab() +
  # xlim(0,40) +
  scale_x_log10() +
  facet_grid(rows = vars(model),
             cols = vars(Route)) +
  scale_fill_manual(values = c("grey5", "green3")) +
  theme_bw() +
  labs(title = "halflife (hours)") +
  theme(
    axis.text.y = element_text(size = 6),
    axis.text.x = element_text(size = 10),
    plot.title = element_text(hjust = 0.5, size = 12),
    axis.title = element_blank()
  )
ggsave(filename = paste0(Sys.getenv("FIG_DIR"),
                         "RestrictiveClearance_Analysis/",
                         "select_",
                         "halflife_bootstrapping.png"),
       bg = "white",
       height = 4, width = 6
)


css_hist <- Css_df_full %>%
  filter(model != "model_flat") %>%
  ggplot(aes(x = Css)) +
  geom_histogram(fill = "grey5", binwidth = 0.2) +
  geom_vline(data = test_chem_full_tkstats,
             aes(xintercept = Css),
             color = "green4",
             linetype = "dashed") +
  facet_grid(rows = vars(model)) +
  labs(title = unique(test_chem_data$Chemical_Name),
       subtitle = paste("Number of samples: ", num_samples)) +
  scale_x_log10() +
  xlim(0,50) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 1),
        plot.subtitle = element_text(hjust = 1))

css_lines <- Css_df_full %>%
  filter(model != "model_flat") %>%
  group_by(model) %>%
  mutate(grouping = row_number()) %>%
  ggplot(aes(x = model, y = Css)) +
  geom_point(alpha = 0.4) +
  geom_line(aes(group=grouping), alpha = 0.02) +
  scale_y_log10() +
  labs(subtitle = "N per timepoint: 4") +
  theme_bw()

get_winning_model(full_pk) %>% filter(Chemical == test_chem) %>% glimpse()

css_hist + css_lines

ggsave(filename = paste0(Sys.getenv("FIG_DIR"),
                         "RestrictiveClearance_Analysis/",
                         "CURRENT_", test_chem,
                         "_Css_pseudobootstrapping.png"),
       bg = "white",
       height = 3, width = 5
)
```



