---
title: "Plot curve fits"
author: "Caroline Ring"
date: "2023-01-04"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(results = TRUE)
knitr::opts_chunk$set(message = FALSE)
```

```{r, include = FALSE}
library(tidyverse)
library(data.table)
library(readxl)
devtools::load_all("../invivopkfit")
```

Timestamp

```{r}
timestamp <- "2023_01_17"
```


Read in CvTdb data pulled in `pulling_oral_iv_data_cvtdb.Rmd`.

```{r, load_cvt, eval = TRUE}
cvt <- fread(paste0("../inst/ext/cvt_preprocessed_",
"2023_01_13",
".csv"))
cvt[, Reference:=as.character(Reference)]
cvt[, Reference_orig:=as.character(Reference_orig)]
```

Read in the fitted model parameter values.

```{r, read_data}

fit_1comp <- fread(paste0("../inst/ext/", "PK_fit_table_1comp_", timestamp, ".csv",sep=""))
fit_2comp <- fread(paste0("../inst/ext/", "PK_fit_table_2comp_", timestamp, ".csv",sep=""))
fit_flat <- fread(paste0("../inst/ext/", "PK_fit_table_flat_", timestamp, ".csv",sep=""))

#pk_lombardo <- read_xlsx("inst/ext/Supplemental_82966_revised_corrected.xlsx")
```

Plot concentration vs time with the best-fit params by data subset (DTXSID and species). 

Indicate the following:

- One line for each model
- Which is the winning model
- Dose group
- Blood vs. plasma
- Below LOQ vs. above LOQ (plot below-LOQ points at LOQ)
- IV vs. oral administration


Plot all models together for the joint analysis.

Produce a data.table with unique combinations of DTXSID, species, analysis type, and studies analyzed.

```{r}
plot_combos <- unique(fit_flat[Analysis_Type %in% "Joint", .(Analysis_Type,
                                                             DTXSID,
                                                             Species,
                                                             Studies.Analyzed)])
setnames(plot_combos,
         names(plot_combos),
         paste(names(plot_combos),
               "in",
               sep = "_"))
```

Loop over the following combinations of options:
- Log-scale y and non-log-scale y
- Dose-normalized and split-dose

```{r}
opts_DT <- as.data.table(expand.grid(log10_scale_y = c(TRUE, FALSE),
                       split_dose = c(TRUE, FALSE)))
opts_DT[, plot_errbars := !(log10_scale_y)]
opts_DT[, plot_dose_norm := !(split_dose)]
opts_DT[plot_errbars %in% TRUE & plot_dose_norm %in% TRUE,
        file_suffix := "errbars_naturaly_dose_norm"]
opts_DT[plot_errbars %in% TRUE & plot_dose_norm %in% TRUE,
        file_path := "../inst/ext/plots/Joint Analysis/model_all/errbars_naturaly/dose_norm"]
opts_DT[plot_errbars %in% FALSE & plot_dose_norm %in% TRUE,
        file_suffix := "noerrbars_logy_dose_norm"]
opts_DT[plot_errbars %in% FALSE & plot_dose_norm %in% TRUE,
        file_path := "../inst/ext/plots/Joint Analysis/model_all/noerrbars_logy/dose_norm"]

opts_DT[plot_errbars %in% TRUE & plot_dose_norm %in% FALSE,
        file_suffix := "errbars_naturaly_dose_split"]
opts_DT[plot_errbars %in% TRUE & plot_dose_norm %in% FALSE,
        file_path := "../inst/ext/plots/Joint Analysis/model_all/errbars_naturaly/dose_split"]
opts_DT[plot_errbars %in% FALSE & plot_dose_norm %in% FALSE,
        file_suffix := "noerrbars_logy_dose_split"]
opts_DT[plot_errbars %in% FALSE & plot_dose_norm %in% FALSE,
        file_path := "../inst/ext/plots/Joint Analysis/model_all/noerrbars_logy/dose_split"]
```

Loop over options, and within each option, loop over datasets, to plot joint analysis with all models.
```{r}
junk <- mapply(function(plot_errbars,
                       log10_scale_y,
                       plot_dose_norm,
                       split_dose,
                       file_suffix,
                       file_path){
  print(file_suffix)
DT_plot <- plot_combos[,
                       .(plot_obj = list(
                         {
                          studies_list <- strsplit(Studies.Analyzed_in,
                               split = ", ")[[1]]
      #get data.table of newdata to be predicted
      #leave out DTXSID, Species columns
      #since these will be added back in from fit_combs
      obs_data <- cvt[DTXSID %in% DTXSID_in &
                           Species %in% Species_in &
                           Study %in% studies_list]
      
      plot_fit(fit_flat = fit_flat,
               fit_1comp = fit_1comp,
               fit_2comp = fit_2comp,
               DTXSID_in = DTXSID_in,
                 Species_in = Species_in,
                 obs_data = obs_data,
                 model_in = "all",
                 Analysis_Type_in = "Joint",
                 plot_dose_norm = plot_dose_norm,
                 split_dose = split_dose,
                 n_interp_time = 10,
                     limit_y_axis = FALSE,
                     log10_scale_y = log10_scale_y,
                     plot_errbars = plot_errbars,
                     log10_scale_time = FALSE,
                 return_plot = TRUE,
                 save_plot = TRUE,
                 file_suffix = file_suffix,
                     file_path = file_path,
                 verbose = FALSE,
                 ggsave_args = list(scale = 1,
                                        width = 13.33,
                                        height = 7.5,
                                        units = "in",
                                        dpi = 300,
                                        limitsize = TRUE,
                                        bg = NULL)
                 )
                       })),
        by = .(DTXSID_in,
               Species_in,
               Analysis_Type_in,
               Studies.Analyzed_in)]

#save all plots as one big paginated file
pdf(paste0(file_path,
              "/all_plots_",
              file_suffix,
              ".pdf"),
    width = 13.33,
                                        height = 7.5)
print(DT_plot$plot_obj)
dev.off()

rm(DT_plot)

return(0)
},
plot_errbars = opts_DT$plot_errbars,
                       log10_scale_y = opts_DT$log10_scale_y,
                       plot_dose_norm = opts_DT$plot_dose_norm,
                       split_dose = opts_DT$split_dose,
file_suffix = opts_DT$file_suffix,
file_path = opts_DT$file_path)

```





