---
title: "Pulling oral and IV data from CvTdb"
author: "Caroline Ring, Gilberto Padilla Mercado"
date: "2023-09-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load necessary package

```{r}
library(DBI)
library(dplyr)
library(tidyr)
```

For connection to CvTdb:

Connect to EPA VPN.

Set environment variables for the user name, password, host, and dbname that will be used to connect. In Windows 10, go to the search bar in the menu and type "environment variables." A menu item should pop up that says "Edit the system environment variables." Click it. A window should pop up. On tab "Advanced " (where you should be already), there is a button "Environment Variables" in the lower right. Click it. Under "User variables for [YOURNAME]", the top window, click the "New" button. Add a variable and value and click "OK". Repeat clicking the "New" button and adding variables. 

Doing it this way allows me to not hardcode the password.

# Connect to database

This is largely taken from a `Querying CvTdb` vignette from Taylor Wall and a previous version
of this vignette authored by Caroline Ring.

The following are some helpter functions for the database connection
```{r query_functions}
postgreSQL_connection <- function() {
  return(
    dbConnect(RPostgreSQL::PostgreSQL(),
              user = Sys.getenv("CVT_USER"),
              password = Sys.getenv("CVT_PASS"),
              host = Sys.getenv("CVT_HOST"),
              dbname = Sys.getenv("CVT_DB_NAME"))
  )
}

query_db <- function(query = NULL, schema) {
  if (is.null(query)) return(cat("\nMust provide a query to send"))
  con <- postgreSQL_connection()
  
  query_result <- tryCatch(
    return(dbGetQuery(con, query %>%
                        gsub("FROM ", paste0("FROM ", schema, "."), .) %>%
                        gsub("JOIN ", paste0("JOIN ", schema, "."), .))),
  error = function(cond){ 
    cat(paste0("\nError message: ", cond))
    return(NULL)
  },
  finally = { 
    dbDisconnect(con)
    }
    )
  return(query_result)
}

```

The following is the new SQL query.

```{r SQL_queries}
# Need to make this in a specified ordered
# First all IDs (so I can check them quickly)
# Note that this uses an ALIAS for each table which is later specified in
# the FROM and LEFT JOIN statments
query <- paste0(
  "SELECT distinct ",
  "a.id, a.time_original,  a.time_hr, a.conc_original, a.conc_sd_original, a.conc, a.conc_sd, ",
  "b.id, b.analyte_name_original, b.analyte_dtxsid, b.analyte_casrn, ",
  "b.fk_analyzed_chemical_id, b.fk_test_chemical_id, ",
  "b.test_substance_dtxsid, b.analyte_name_secondary_original, ",
  "b.conc_medium_normalized, b.conc_medium_original, b.time_units_original, b.conc_units_original, ",
  "b.conc_units_normalized, b.loq, b.loq_units, b.n_subjects_in_series, b.radiolabeled, ",
  "c.id, c.administration_route_normalized, c.fk_dosed_chemical_id, c.dose_volume, c.dose_vehicle, ",
  "c.dose_duration, c.dose_duration_units, c.dose_frequency, c.fasting_period, ",
  "c.dose_level_normalized, c.dose_level_original, c.dose_level_units_original, ",
  "d.id, d.weight_kg, d.species, d.sex, d.age, d.age_units, d.age_category, ",
  "e.id, e.pmid, e.year, e.other_study_identifier, e.url, e.doi, e.extracted, e.curation_set_tag ",
  
  # Main Table
  "FROM conc_time_values a ",
  
  # Join with series table by series ID
  "LEFT JOIN series b ON b.id = a.fk_series_id ",
  
  # Join to studies table by study ID
  "LEFT JOIN studies c ON c.id = b.fk_study_id ",
  
  # Join to subjects table by subject ID
  "LEFT JOIN subjects d ON d.id = b.fk_subject_id ",
  
  # Join to documents table by extraction document ID
  "LEFT JOIN documents e ON e.id = c.fk_extraction_document_id ",
  
  # Filtering steps
  "WHERE b.conc_medium_normalized IN ('blood', 'plasma') OR ",
  "b.conc_medium_original IN ('blood', 'plasma') AND ",
  "c.administration_route_normalized IN ('iv', 'oral')"
)

sql_query <- query_db(query = query,
         schema = "cvt")

dtxsid_query <- paste0(
  "SELECT distinct * FROM chemicals"
)

dtxsid_query <- query_db(query = dtxsid_query,
         schema = "cvt")

dq_cols <- dtxsid_query %>%
  dplyr::select("analyte_dtxsid2" = "dsstox_substance_id",
         "fk_analyzed_chemical_id" = "id",
         "analyte_name_original" = "chemical_name_original") %>%
  distinct()

glimpse(dq_cols)


names(sql_query)
# Need to change column names for this
{
  names(sql_query)[1] <- "conc_time_id"
  names(sql_query)[8] <- "series_id"
  names(sql_query)[25] <- "study_id"
  names(sql_query)[37] <- "subject_id"
  names(sql_query)[44] <- "document_id"
}

full_set <- sql_query %>%
  left_join(dq_cols, 
            by = join_by("fk_analyzed_chemical_id", "analyte_name_original")) %>%
  mutate(analyte_dtxsid = ifelse(is.na(analyte_dtxsid), analyte_dtxsid2, analyte_dtxsid)) %>%
  select(-analyte_dtxsid2)

# Harmonize values for easier analysis
cvt_df <- full_set %>%
  filter(administration_route_normalized %in% c("iv", "oral")) %>%
  mutate(
    species = tolower(species),
    sex = tolower(sex),
    loq = as.numeric(loq),
    n_subjects_in_series = as.numeric(n_subjects_in_series),
    dose_level_normalized = as.numeric(dose_level_normalized),
    dose_level_original = as.numeric(dose_level_original),
    dose_volume_units = stringr::str_extract(dose_volume,
                                    pattern = "(?<=[:space:]).+"),
    dose_volume = as.numeric(stringr::str_extract(dose_volume,
                                         pattern = "^(\\d|\\.)*")),
    dose_duration_units = stringr::str_extract(dose_duration,
                                      pattern = "(?<=[space]).+"),
    dose_duration = as.numeric(stringr::str_extract(dose_duration,
                                pattern = "^\\d")),
    radiolabeled = ifelse(radiolabeled == 1, TRUE, FALSE)
  )


cvt_df <- cvt_df %>%
  mutate(conc_medium_normalized = ifelse(is.na(conc_medium_normalized),
                                         conc_medium_original,
                                         conc_medium_normalized))
```



# Validating data

This step in the loading process allows us to correct some mis-annotations in the
data, without directly changing CvTdb (the review process there is more rigorous).
Some of these changes will be sent as a ticket item for the CvTdb team.
Other times, the annotation is correct, it's just that units need to be standardized
for `invivoPKfit` specifically.  

To summarize the changes:  

-  Change original dose units for study _S0916_ and convert to mg/kg.  
-  Change original dose units for study _S0624_ and convert to mg/kg.  
-  Include a series of isotope tracing experiments from documents _65_, _61_, _46_, and _31_.  
-  Input the LOQ for studies _S0976_ & _S0361_.  
-  Infer the LOQ for study _S0328_ as 1, given the values near it deemed above and below LOQ.  
-  Extraction from PMID:6310077 reflects a _% of Dose_, so we converted this to mg/kg.  
-  Input DTXSIDs for chemicals that did not have them but were available via CompTox dashboard.  
-  Standardize all Doses, LOQs, Concentrations, and Concentration standard deviations.  
-  Filter out chemicals dosed multiple times throughout the experiment.  
-  Filter out chemicals with very limited information.  


```{r data_validation}
# Check other_study_identifier == S0916 so that it has dose_level_units_original == ug/mL
cvt_df %>% filter(other_study_identifier == "S0916") %>%
  pull(dose_level_units_original) %>% unique()
# There are still columns that are mg/kg... changing these to ug/mL
cvt_df <- cvt_df %>% mutate(
  dose_level_units_original = ifelse(
    other_study_identifier == "S0916",
    "ug/mL",
    dose_level_units_original
  )
)
cvt_df %>% pull(analyte_dtxsid) %>% unique() %>% length()

# Need to convert the units to mg/kg
# In pulling_oral_iv_data_cvtdb.Rmd, it is noted that oral was 5mL/kg and iv 2mL/kg
# So I need to do ug/mL * mL/kg * 1mg/1000ug = mg/kg
cvt_df <- cvt_df %>%
  mutate(
    dose_level_corrected = ifelse(
      other_study_identifier %in% "S0916",
      ifelse(administration_route_normalized %in% "oral",
             dose_level_original * 5/1000,
             dose_level_original * 2/1000),
      dose_level_normalized),
    dose_level_corrected_units = "mg/kg",
    .after = dose_level_units_original)

# For this study, it was in ng/kg not mg/kg
cvt_df <- cvt_df %>%
  mutate(
    dose_level_corrected = ifelse(
      other_study_identifier %in% "S0624",
      dose_level_original * 1E-6,
      dose_level_normalized),
    .after = dose_level_units_original)

cvt_df %>% pull(analyte_dtxsid) %>% unique() %>% length()

# The following measured C-14/H-3 but are indicators for the following Chemicals
# document_id = 65, DTXSID = DTXSID7031290, name = Isocyclemone E or beta-OTNE
# document_id = 61, DTXSID = DTXSID4022527, DTXSID3020209,
### name(s) = propylparaben, butylparaben, missing...methylparaben
# Propylparaben SERIES_ID = 110, Butylparaben SERIES_ID = 112
# For above, HPLC reviealed a single peak corresponding with p-hydroxybenzoic acid (PHBA, DTXSID3026647)
# document_id = 46, DTXSID = DTXSID2020139, name = benzo[a]pyrene
# document_id = 31, DTXSID = DTXSID2020139, name = benzo[a]pyrene

# However, now would be good time to eliminate any ones where they analyte != test chemical
# Some studies may have dosed with multiple chemicals... important to note
# cvt_df <- cvt_df %>% filter(analyzed_chemical_id == test_chemical_id)
# For now, I will change the chemical name and dtxsid
cvt_df <- cvt_df %>%
  mutate(analyte_dtxsid = ifelse(document_id %in% 65, "DTXSID7031290",
                                 analyte_dtxsid),
         analyte_name_original = ifelse(document_id %in% 65, "beta-OTNE",
                                        analyte_name_original)) %>%
  mutate(analyte_dtxsid = ifelse(document_id %in% 61,
                                 case_when(
                                   series_id %in% 110 ~ "DTXSID4022527",
                                   series_id %in% 112 ~ "DTXSID3020209",
                                   .default = analyte_dtxsid
                                 ),
                                 analyte_dtxsid),
         analyte_name_original = ifelse(document_id %in% 61,
                                 case_when(
                                   series_id %in% 110 ~ "Propylparaben",
                                   series_id %in% 112 ~ "Butylparaben",
                                   .default = analyte_name_original
                                 ),
                                 analyte_name_original)
         ) %>%
  mutate(analyte_dtxsid = ifelse(document_id %in% c(46, 31),
                                 "DTXSID2020139",
                                 analyte_dtxsid),
         analyte_name_original = ifelse(document_id %in% c(46, 31),
                                        "benzo[a]pyrene",
                                        analyte_name_original))

# For study S0976, Caffeine, L-ephedrine, and psuedoephedrine were dosed
cvt_df <- cvt_df %>%
  mutate(loq = ifelse(
    other_study_identifier %in% "S0976",
    case_when(
      analyte_name_original %in% "Caffeine" ~ 4.00,
      analyte_name_original %in% "L-Ephedrine" ~ 3.39,
      analyte_name_original %in% "Pseudoephedrine" ~ 4.43
    ),
    loq),
    loq_units = ifelse(
      other_study_identifier %in% "S0976",
      "ng/mL",
      loq_units
    ),
    conc_units_original = ifelse(other_study_identifier %in% "S0976", "mg/L", conc_units_original))

# Some pentachloranisole studies
# S0361 seems to have some data that has not been extracted (also for mouse)
cvt_df <- cvt_df %>%
  mutate(loq = case_when(
    # here omitted a change to a value for LOQ that doubles the minimum detected limit
    other_study_identifier %in% "S0328" ~ 1, # This is inferred from the data
    # Highest value under loq is 0.9
    # Lowest value above loq is 1.263, but there are differences in GC-EC and HPLC methods
    # The method of imputation for loq may yet need to be improved
    .default = loq
  ),
  loq_units = case_when(
    other_study_identifier %in% "S0361" ~ "ug/mL",
    other_study_identifier %in% "S0328" ~ "ug/mL",
    .default = loq_units
  ))
cvt_df %>% pull(analyte_dtxsid) %>% unique() %>% length()
# PMID 6310077 is a tritium tracing of B[a]P and these were given as % of Dose
# The initial dose was 117 nmol, 2 mCi/kg
# Molecular Mass of benzo[a]pyrene (C20H12) is 252.316 g/mol
# The initial dose *I think* is in dose_level_normalized
cvt_df <- cvt_df %>%
  mutate(conc = as.numeric(conc),
         conc_original = as.numeric(conc)) %>%
  mutate(conc = ifelse(document_id %in% 38,
                       conc_original*dose_level_corrected,
                       conc))

# NTP-CEB C96019 just has a lot of data below LOQ
# For S0916, there is no > LOQ data for anything but Tamoxifen
# N-di-butyl phthalate is only good at the iv dose
# DTXSID2021315 is only good at 1E-4 Dose
# S0623 Doesn't have any plasma data
# There is a maybe control sample for hexachlorobenzene (Dose = 0.0 ) ?

# Give N-desmethyltamoxifen it's due DTXSID501315924
cvt_df <- cvt_df %>%
  mutate(analyte_dtxsid = ifelse(
    analyte_name_original %in% "N-desmethyltamoxifen",
    "DTXSID501315924",
    analyte_dtxsid
  ))

cvt_df <- cvt_df %>%
  mutate(analyte_dtxsid = ifelse(
    analyte_name_original %in% "Methemoglobin",
    "DTXSID301056085",
    analyte_dtxsid
  ))

# Standardizing the names (example: glucuronide had two entries)
cvt_df <- cvt_df %>%
  mutate(analyte_name_original = tolower(analyte_name_original))

# Eliminate study that gave chemical each day, not single dose
# This may be used in another type of model, but right now we deal with single bolus
# Only include those that have NA or 1 for dose frequency
cvt_df <- cvt_df %>%
  filter(dose_frequency %in% c("1", NA))
cvt_df %>% pull(analyte_dtxsid) %>% unique() %>% length()

cvt_df$loq_units %>% unique()
# Normalize LOQ units
cvt_df <- cvt_df %>%
  mutate(loq = ifelse(
    loq_units %in% c("ug/L", "ng/mL", "ng/g"), loq * 1E-3, loq)) # mg/L and ug/mL are same scale
# Normalize conc_sd and conc units manually
cvt_df <- cvt_df %>%
  mutate(conc_sd_original = as.numeric(conc_sd_original)) %>%
  mutate(conc_sd_normalized = case_when(
    conc_units_original %in% c("ng-eq/mL", "ng/mL", "ng/ml", "ng/g", "ng/g tissue", "ug/L") ~ conc_sd_original*1E-3,
    conc_units_original %in% c("g/dL") ~ conc_sd_original*1E-4,
    conc_units_original %in% c("pg/mL") ~ conc_sd_original*1E-6,
    .default = conc_sd_original
  ))
# Need to normalize the ng-eq/mL sample, conc is generally already normalized
cvt_df <- cvt_df %>%
  mutate(conc = case_when(
    conc_units_original %in% c("ng-eq/mL", "ng/mL", "ng/ml",
                               "ng/g", "ng/g tissue", "ug/L") ~ conc_original*1E-3,
    conc_units_original %in% c("g/dL") ~ conc_original*1E-4,
    conc_units_original %in% c("pg/mL") ~ conc_original*1E-6,
    .default = conc
  ))
cvt_df %>% pull(analyte_dtxsid) %>% unique() %>% length()
# Some chemicals have very few values
cvt_df <- cvt_df %>%
  dplyr::filter(!(analyte_dtxsid %in% c("DTXSID501315924",
                                      "DTXSID10169854",
                                      "DTXSID2021103",
                                      "DTXSID6038299") ),
                administration_route_normalized %in% c("iv", "oral"))
cvt_df %>% pull(analyte_dtxsid) %>% unique() %>% length()
# More notes:
# DTXSID6020438 & DTXSID0020868 rat is from water (top) and oil (bottom curve) gavage
cvt_df %>% count(curation_set_tag)

# This is the final filtering so that the dataset is most consistent with the
# most current near future pull in the new year
cvt_df <- cvt_df %>%
  filter(!is.na(analyte_dtxsid),
         fk_analyzed_chemical_id == fk_dosed_chemical_id, # sometimes test chemical id is not filled out :/
         !(document_id %in% c(38, 65, 110, 112, 46, 31)),
         !(other_study_identifier %in% c("S0916") & is.na(conc)),
         !(analyte_name_original %in% "methemoglobin"),
         radiolabeled %in% c(NA, FALSE) # Legacy left as NA, other curations explicitly state FALSE
         )
cvt_df %>% distinct(analyte_dtxsid, curation_set_tag) %>% count(curation_set_tag)
cvt_df %>% pull(analyte_dtxsid) %>% unique() %>% length()


cvt_df %>%
  pull(conc_units_original) %>%
  table()
cvt_df %>%
  filter(conc_units_original %in% "molar percentage") %>%

cvt_df <- cvt_df %>%
  filter(!is.na(conc)) %>%
  mutate(conc = case_when(
    conc_units_original %in% "umol/kg" ~ conc * dose_level_corrected,
    # Some concentration values are in uM
    document_id %in% 62 ~ conc * 179.219/1E3,
    document_id %in% 51 & analyte_dtxsid %in% "DTXSID3020833" ~ conc * 88.15/1E3,
    document_id %in% 51 & analyte_dtxsid %in% "DTXSID3020833" ~ conc * 102.177/1E3,
    .default = conc
  )) %>%
    mutate(conc_sd_normalized = case_when(
    conc_units_original %in% "umol/kg" ~ conc_sd_original * dose_level_corrected,
    # Some concentration values are in uM
    document_id %in% 62 ~ conc_sd_original * 179.219/1E3,
    document_id %in% 51 & analyte_dtxsid %in% "DTXSID3020833" ~ conc_sd_original * 88.15/1E3,
    document_id %in% 51 & analyte_dtxsid %in% "DTXSID3020833" ~ conc_sd_original * 102.177/1E3,
    .default = conc_sd_original
  ))
cvt_df %>% distinct(analyte_dtxsid, curation_set_tag) %>% count(curation_set_tag)
```


This filtered and transformed dataset has 14,152 observations.


Save the pulled CVT data with the edits/normalizations, and also save the current date.

```{r}
cvt_date <- Sys.Date()
cvt <- cvt_df
cvt <- cvt %>% mutate(conc_normalized_units = "mg/L")
save(cvt, file = "data/cvt.rda", compress = "bzip2")
save(cvt_date, file = "data/cvt_date.rda")
```




