---
title: "Restrictive Clearance Comparison"
author: "Gilberto Padilla Mercado"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This vignette describes comparisons between invivoPKfit predicted and those from httk.

```{r library_loading}
devtools::load_all()
library(httk)
my_pk <- readRDS("data-raw/all_cvt_pk_JOINT.rds")
```


The first thing I need to do is get the chemicals included in both the CvTdb subset
and the httk empirical data for pbpk.

```{r chems_in_common}
common_chems <- cvt %>%
  subset(analyte_dtxsid %in% get_cheminfo(info = "DTXSID", model = "gas_pbtk")) %>%
  pull(analyte_dtxsid) %>%
  unique()

common_chems[!(common_chems %in% get_cheminfo(info = "DTXSID", model = "gas_pbtk"))] %>%
  unique() %>%
  sort()
```

Next I need to get the clearances using the `calc_total_clearance(dtxsid, restrictive.clearance)`
function from httk. Also need the clearances from invivoPKfit's winning models.


```{r get_clearances}
clearance_df <- data.frame(Chemical = common_chems) %>%
  rowwise() %>%
  mutate(Restrict_Cl = calc_total_clearance(dtxsid = Chemical,
                                            restrictive.clearance = TRUE,
                                            suppress.messages = TRUE),
         nonRestrict_Cl = calc_total_clearance(dtxsid = Chemical,
                                            restrictive.clearance = FALSE,
                                            suppress.messages = TRUE)) %>%
  ungroup()

hep_clearance_df <- data.frame(Chemical = common_chems) %>%
  rowwise() %>%
  mutate(Restrict_Cl = calc_hep_clearance(dtxsid = Chemical,
                                            restrictive.clearance = TRUE,
                                            suppress.messages = TRUE),
         nonRestrict_Cl = calc_hep_clearance(dtxsid = Chemical,
                                            restrictive.clearance = FALSE,
                                            suppress.messages = TRUE)) %>%
  ungroup()

my_tkstats <- eval_tkstats(my_pk) %>%
  dplyr::select(Chemical, Species, CLtot.tkstats, CLtot.nca) %>%
  distinct() %>%
  filter(Chemical %in% common_chems,
         !is.na(CLtot.tkstats), !is.na(CLtot.nca)) %>%
  group_by(Chemical, Species, CLtot.tkstats) %>%
  summarize(CLtot.nca_mean = mean(CLtot.nca),
            CLtot.nca_sd = sd(CLtot.nca))

# Combine these two
combined_clearance_df <- my_tkstats %>% inner_join(clearance_df)

```


Finally, let's visualize where the tkstats predictions land.

```{r viz}

# Preliminary viz, plot all clearances
combined_clearance_df %>%
  relocate(CLtot.nca_mean, CLtot.nca_sd, .after = tidyselect::last_col()) %>%
  pivot_longer(cols = 3:6,
               names_to = "Clearance_Source",
               values_to = "Value") %>%
  ggplot(aes(x = Value,
             y = Chemical,
             fill = Clearance_Source)) +
  geom_point(shape = 21, alpha = 0.7) +
  scale_x_log10() +
  scale_fill_manual(breaks = c("nonRestrict_Cl", "CLtot.tkstats",
                               "CLtot.nca_mean",
                               "Restrict_Cl"),
                    labels = c("non-restrictive clearance (httk)",
                               "predicted clearance (invivoPKfit)",
                               "mean non-compartmental total clearance (invivoPKfit)",
                               "restrictive clearance (httk)"),
                    values = c("orange2", "grey5", "skyblue3",  "green4")) +
  facet_grid(rows = vars(Species), scales = "free", space = "free") +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom",
        legend.direction = "vertical",
        axis.ticks = element_blank(),
        axis.line = element_blank())


ggsave(filename = paste0(Sys.getenv("FIG_DIR"),
                         "tkClearance_comparison_httk_gasPBPK.png"),
       height = 14,
       width = 5,
       device = "png")
```

Finally, what I want to analyze is how good the fits for these chemicals are relative to the rest of the chemicals.

```{r fit_analysis}
wm <- get_winning_model(my_pk)
ingroup_rmse <- rsq(my_pk) %>% inner_join(wm) %>%
  filter(Chemical %in% combined_clearance_df$Chemical) %>%
  mutate(Group = "in httk")

outgroup_rmse <- rsq(my_pk) %>% inner_join(wm) %>%
  filter(!(Chemical %in% combined_clearance_df$Chemical)) %>%
  mutate(Group = "not in httk")

all_group_rmse <- bind_rows(ingroup_rmse, outgroup_rmse)


all_group_rmse %>%
  filter(Species == "rat") %>%
  ggplot(aes(x = Rsq, y = Chemical,
             shape = Group)) +
  geom_point() +
  facet_grid(rows = vars(Group), scales = "free", space = "free") +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        legend.direction = "vertical",
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank())

ggsave(paste0(Sys.getenv("FIG_DIR"), "Rsq_gaspbtk.png"),
       height = 5,
       width = 5)
  

```

## Exploring _httk_ parameters and solved values for `gas_pbtk`

```{r httk_solution}
httk::calc_tkstats(dtxsid = unique(combined_clearance_df$Chemical)[[5]])
httk::parameterize_gas_pbtk(restrictive.clearance = TRUE,
                            dtxsid = unique(combined_clearance_df$Chemical)[[5]])

httk::solve_gas_pbtk(dtxsid = unique(combined_clearance_df$Chemical)[[5]],
                     parameters = httk::parameterize_gas_pbtk(
                       restrictive.clearance = TRUE,
                       dtxsid = unique(combined_clearance_df$Chemical)[[5]]
                       ),
                     dose = 10,
                     exp.conc = 0,
                     input.units = "mg",
                     output.units = "mg",
                     days = 3,
                     plots = TRUE)


# For the invivoPKfit functions, we will hold kelim constant
# This constant will be calculated as CLtot/Vdist (or V1, if 2-compartment)
# This constant is derived by httk in the following way:
calc_total_clearance(dtxsid = common_chems[[10]],
                             restrictive.clearance = FALSE) /
  calc_vdist(dtxsid = common_chems[[10]])

```

I have modified the starts of the 1- and 2-compartment models,
as well as adding a restrictive_clearance argument in stat_model.

```{r running-invivoPKfit}
minimal_pk <- pk(data = cvt %>%
                   filter(analyte_dtxsid %in% common_chems[1:8]),
                 mapping = ggplot2::aes(
                   Chemical = analyte_dtxsid,
                   Chemical_Name = analyte_name_original,
                   DTXSID = analyte_dtxsid,
                   CASRN = analyte_casrn,
                   Species = species,
                   Reference = document_id,
                   Media = conc_medium_normalized,
                   Route = administration_route_normalized,
                   Dose = dose_level_normalized,
                   Dose.Units = "mg/kg",
                   Subject_ID = subject_id,
                   Series_ID = series_id,
                   Study_ID = study_id,
                   ConcTime_ID = conc_time_id,
                   N_Subjects = n_subjects_in_series,
                   Weight = weight_kg,
                   Weight.Units = "kg",
                   Time = time_hr,
                   Time.Units = "hours",
                   Value = conc,
                   Value.Units = "mg/L",
                   Value_SD = conc_sd_normalized,
                   LOQ = loq
                 ))


new_pk <- minimal_pk +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE,
                      suppress.messages = FALSE) +
  settings_optimx(method = c("L-BFGS-B")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  stat_error_model(error_group = vars(Chemical, Species, Reference)) +
  stat_model(model = c("model_flat", "model_1comp", "model_2comp",
                       "model_1comp_rest", "model_1comp_nonrest",
                       "model_2comp_rest", "model_2comp_nonrest"))
new_pk <- do_data_info(new_pk)


new_pk <- do_prefit(new_pk)

new_pk$prefit$par_DF %>% arrange(Chemical, Species) %>% filter(param_name == "kelim") %>%
  View()

new_pk <- do_fit(new_pk) # For troubleshooting



new_pk <- do_fit(new_pk, n_cores = 6) 
# Multidplyr error because of forgotten browser() call within log_likelihood
new_pk$fit %>% unnest(fit) %>% View()

coef(new_pk) %>% View()
eval_tkstats(new_pk) %>% View()


AIC(new_pk) %>% filter(method %in% "L-BFGS-B") %>% arrange(Chemical, Species) %>%
  View()

pl2comp <- plot(new_pk, use_scale_conc = FALSE,
           model = "model_2comp_nonrest",
           n_interp = 10)


pl2comp %>%
  filter(Chemical %in% "DTXSID0021383") %>% pull(final_plot) %>% .[[1]]
```


Why are so many fits failing?
Well, we should take a look at the parameter which we are holding constant,
`kelim` and whether the new starting points vastly differ from those in the
starting points based on the data.

For this I will just use the PK object I have saved `my_pk` and take the
_prefit_ parameter estimations and first compare that with eventual optimized `kelim`.

```{r kelim-questions}

# Original data, filtered for common_chems
# par_DF
my_kelim_prefit <- my_pk$prefit$par_DF %>%
  filter(param_name %in% "kelim",
         Chemical %in% common_chems) %>%
  distinct(Chemical, Species, param_name, lower_bound, upper_bound, start)

my_kelim_fit <- coef(my_pk) %>%
  inner_join(get_winning_model(my_pk)) %>%
  ungroup() %>%
  distinct(model, Chemical, Species, kelim) %>%
  rename(fit_kelim = "kelim") %>%
  filter(Chemical %in% common_chems)

my_kelim_df <- inner_join(my_kelim_fit, my_kelim_prefit)


httk_df <- rest_pk$prefit$par_DF %>%
  filter(param_name %in% "kelim") %>%
  distinct(Chemical, Species, param_name, start) %>%
  rename(init_restrictive = "start") %>%
  inner_join(
    nonrest_pk$prefit$par_DF %>%
  filter(param_name %in% "kelim") %>%
  distinct(Chemical, Species, param_name, start) %>%
  rename(init_nonrestrictive = "start"))


full_df <- inner_join(my_kelim_df, httk_df) %>%
  relocate(fit_kelim, .after = last_col())


full_df %>%
  ggplot(aes(x = Chemical)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "grey30") +
  geom_errorbar(aes(ymax = upper_bound, ymin = lower_bound)) +
  geom_point(aes(y = fit_kelim, color = "Original Optimized")) +
  geom_point(aes(y = init_restrictive, color = "Restrictive")) +
  geom_point(aes(y = init_nonrestrictive, color = "Non-restrictive")) +
  geom_point(aes(y = start, shape = "Original Initialized")) +
  facet_grid(rows = vars(Species), scales = "free", space = "free") +
  scale_color_manual(name = "kelim",
                     breaks = c("Original Optimized", "Restrictive", "Non-restrictive"),
                     values = c("Original Optimized" = "skyblue4", 
                                "Restrictive" = "orange2",
                                "Non-restrictive" = "green4")) +
  scale_shape_manual(name = "",
                     values = 4) +
  coord_flip() +
  scale_y_log10(labels = scales::label_math(format = log10)) +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        legend.direction = "vertical",
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank(),
        strip.text.y = element_text(angle = 0))


ggsave(filename = paste0(Sys.getenv("FIG_DIR"), "kelim_compare_2024_0329.png"),
       height = 11,
       width = 8.5)
```

```{r testing_optimx}
test_optimx <- do.call(
          optimx::optimx,
          args = c(
            list(par = opt_params,
                 fn = log_likelihood,
                 lower = lower_params,
                 upper = upper_params),
            #method and control
            settings_optimx,
            #... additional args to log_likelihood
            list(
              const_params = const_params,
              data = data,
              data_sigma_group = data$data_sigma_group,
              modelfun = modelfun,
              dose_norm = dose_norm,
              log10_trans = log10_trans,
              negative = TRUE,
              force_finite = TRUE,
              suppress.messages = FALSE
            ) #end list()
          ) #end args = c()
        ) #end do.call
```



```{r}

rest_wm <- get_winning_model(rest_pk)
rest_AIC <- AIC(rest_pk)
rest_rsq <- rsq(rest_pk)

eval_tkstats(rest_pk) %>% View()
residuals(rest_pk) %>% View()



pl <- plot(rest_pk, n_interp = 12, use_scale_conc = TRUE)
pdf(file = paste0(Sys.getenv("FIG_DIR"),
              "RestrictiveCL_AllFits_Final_202402_08.pdf"),
    height = 6, width = 10)
for (i in 1:nrow(pl)) {
  print(pl$final_plot[[i]])
}
dev.off()




# Non-restrictive fits (constant kelim)

pl <- plot(nonrest_pk, n_interp = 12, use_scale_conc = TRUE)
pdf(file = paste0(Sys.getenv("FIG_DIR"),
              "Non-restrictiveCL_AllFits_Final_202402_08.pdf"),
    height = 6, width = 10)
for (i in 1:nrow(pl)) {
  print(pl$final_plot[[i]])
}
dev.off()




# try dawson
httk::load_dawson2021()

```

