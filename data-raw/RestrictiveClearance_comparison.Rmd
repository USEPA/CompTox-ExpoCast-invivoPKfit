---
title: "Restrictive Clearance Comparison"
author: "Gilberto Padilla Mercado"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This vignette describes comparisons between invivoPKfit predicted and those from httk.

```{r library_loading}
devtools::load_all()
library(httk)
library(tidyverse)
my_pk <- readRDS("data-raw/all_cvt_pk_JOINT.rds")
```


The first thing I need to do is get the chemicals included in both the CvTdb subset
and the httk empirical data for pbpk.

```{r chems_in_common}
common_chems <- cvt %>%
  subset(analyte_dtxsid %in% get_cheminfo(info = "DTXSID", model = "gas_pbtk")) %>%
  pull(analyte_dtxsid) %>%
  unique()

common_chems[!(common_chems %in% get_cheminfo(info = "DTXSID", model = "gas_pbtk"))] %>%
  unique() %>%
  sort()
```

Next I need to get the clearances using the `calc_total_clearance(dtxsid, restrictive.clearance)`
function from httk. Also need the clearances from invivoPKfit's winning models.


```{r get_clearances}
clearance_df <- data.frame(Chemical = common_chems) %>%
  rowwise() %>%
  mutate(Restrict_Cl = calc_total_clearance(dtxsid = Chemical,
                                            restrictive.clearance = TRUE,
                                            suppress.messages = TRUE),
         nonRestrict_Cl = calc_total_clearance(dtxsid = Chemical,
                                            restrictive.clearance = FALSE,
                                            suppress.messages = TRUE)) %>%
  ungroup()

hep_clearance_df <- data.frame(Chemical = common_chems) %>%
  rowwise() %>%
  mutate(Restrict_Cl = calc_hep_clearance(dtxsid = Chemical,
                                            restrictive.clearance = TRUE,
                                            suppress.messages = TRUE),
         nonRestrict_Cl = calc_hep_clearance(dtxsid = Chemical,
                                            restrictive.clearance = FALSE,
                                            suppress.messages = TRUE)) %>%
  ungroup()

my_tkstats <- eval_tkstats(my_pk) %>%
  dplyr::select(Chemical, Species, CLtot.tkstats, CLtot.nca) %>%
  distinct() %>%
  filter(Chemical %in% common_chems,
         !is.na(CLtot.tkstats), !is.na(CLtot.nca)) %>%
  group_by(Chemical, Species, CLtot.tkstats) %>%
  summarize(CLtot.nca_mean = mean(CLtot.nca),
            CLtot.nca_sd = sd(CLtot.nca))

# Combine these two
combined_clearance_df <- my_tkstats %>% inner_join(clearance_df)

```


Finally, let's visualize where the tkstats predictions land.

```{r viz}

# Preliminary viz, plot all clearances
combined_clearance_df %>%
  relocate(CLtot.nca_mean, CLtot.nca_sd, .after = tidyselect::last_col()) %>%
  pivot_longer(cols = 3:6,
               names_to = "Clearance_Source",
               values_to = "Value") %>%
  ggplot(aes(x = Value,
             y = Chemical,
             fill = Clearance_Source)) +
  geom_point(shape = 21, alpha = 0.7) +
  scale_x_log10() +
  scale_fill_manual(breaks = c("nonRestrict_Cl", "CLtot.tkstats",
                               "CLtot.nca_mean",
                               "Restrict_Cl"),
                    labels = c("non-restrictive clearance (httk)",
                               "predicted clearance (invivoPKfit)",
                               "mean non-compartmental total clearance (invivoPKfit)",
                               "restrictive clearance (httk)"),
                    values = c("orange2", "grey5", "skyblue3",  "green4")) +
  facet_grid(rows = vars(Species), scales = "free", space = "free") +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        legend.position = "bottom",
        legend.direction = "vertical",
        axis.ticks = element_blank(),
        axis.line = element_blank())


ggsave(filename = paste0(Sys.getenv("FIG_DIR"),
                         "tkClearance_comparison_httk_gasPBPK.png"),
       height = 14,
       width = 5,
       device = "png")
```

Finally, what I want to analyze is how good the fits for these chemicals are relative to the rest of the chemicals.

```{r fit_analysis}
wm <- get_winning_model(my_pk)
ingroup_rmse <- rsq(my_pk) %>% inner_join(wm) %>%
  filter(Chemical %in% combined_clearance_df$Chemical) %>%
  mutate(Group = "in httk")

outgroup_rmse <- rsq(my_pk) %>% inner_join(wm) %>%
  filter(!(Chemical %in% combined_clearance_df$Chemical)) %>%
  mutate(Group = "not in httk")

all_group_rmse <- bind_rows(ingroup_rmse, outgroup_rmse)


all_group_rmse %>%
  filter(Species == "rat") %>%
  ggplot(aes(x = Rsq, y = Chemical,
             shape = Group)) +
  geom_point() +
  facet_grid(rows = vars(Group), scales = "free", space = "free") +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        legend.direction = "vertical",
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank())

ggsave(paste0(Sys.getenv("FIG_DIR"), "Rsq_gaspbtk.png"),
       height = 5,
       width = 5)
  

```

## Exploring _httk_ parameters and solved values for `gas_pbtk`

```{r httk_solution}
httk::calc_tkstats(dtxsid = unique(combined_clearance_df$Chemical)[[5]])
httk::parameterize_gas_pbtk(restrictive.clearance = TRUE,
                            dtxsid = unique(combined_clearance_df$Chemical)[[5]])

httk::solve_gas_pbtk(dtxsid = unique(combined_clearance_df$Chemical)[[5]],
                     parameters = httk::parameterize_gas_pbtk(
                       restrictive.clearance = TRUE,
                       dtxsid = unique(combined_clearance_df$Chemical)[[5]]
                       ),
                     dose = 10,
                     exp.conc = 0,
                     input.units = "mg",
                     output.units = "mg",
                     days = 3,
                     plots = TRUE)


# For the invivoPKfit functions, we will hold kelim constant
# This constant will be calculated as CLtot/Vdist (or V1, if 2-compartment)
# This constant is derived by httk in the following way:
calc_total_clearance(dtxsid = common_chems[[10]],
                             restrictive.clearance = FALSE) /
  calc_vdist(dtxsid = common_chems[[10]])

```

I have modified the starts of the 1- and 2-compartment models,
as well as adding a restrictive_clearance argument in stat_model.

```{r running-invivoPKfit}
minimal_pk <- pk(data = cvt %>%
                   filter(analyte_dtxsid %in% common_chems),
                 mapping = ggplot2::aes(
                   Chemical = analyte_dtxsid,
                   Chemical_Name = analyte_name_original,
                   DTXSID = analyte_dtxsid,
                   CASRN = analyte_casrn,
                   Species = species,
                   Reference = document_id,
                   Media = conc_medium_normalized,
                   Route = administration_route_normalized,
                   Dose = dose_level_normalized,
                   Dose.Units = "mg/kg",
                   Subject_ID = subject_id,
                   Series_ID = series_id,
                   Study_ID = study_id,
                   ConcTime_ID = conc_time_id,
                   N_Subjects = n_subjects_in_series,
                   Weight = weight_kg,
                   Weight.Units = "kg",
                   Time = time_hr,
                   Time.Units = "hours",
                   Value = conc,
                   Value.Units = "mg/L",
                   Value_SD = conc_sd_normalized,
                   LOQ = loq
                 ))


new_pk <- minimal_pk +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE,
                      suppress.messages = FALSE) +
  settings_optimx(method = c("L-BFGS-B")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  stat_error_model(error_group = vars(Chemical, Species, Reference)) +
  stat_model(model = c("model_flat", "model_1comp", "model_2comp",
                       "model_1comp_rest", "model_1comp_nonrest",
                       "model_2comp_rest", "model_2comp_nonrest"))
new_pk <- do_data_info(new_pk)


new_pk <- do_prefit(new_pk)

new_pk$prefit$par_DF %>% arrange(Chemical, Species) %>% filter(param_name == "kelim") %>%
  View()

new_pk <- do_fit(new_pk) # For troubleshooting



new_pk <- do_fit(new_pk, n_cores = 10) 
# Multidplyr error because of forgotten browser() call within log_likelihood
new_pk$fit %>% unnest(fit) %>% View()

coef(new_pk) %>% View()
eval_tkstats(new_pk, finite_only = FALSE) %>% View()
get_winning_model(new_pk) %>% View("winning_model")


AIC(new_pk) %>% filter(method %in% "L-BFGS-B") %>% arrange(Chemical, Species) %>%
  View()

pl2comp <- plot(new_pk, use_scale_conc = FALSE,
           model = "model_2comp_nonrest",
           n_interp = 10)


pl2comp %>%
  filter(Chemical %in% "DTXSID0021383") %>% pull(final_plot) %>% .[[1]]
```


Why are so many fits failing?
Well, we should take a look at the parameter which we are holding constant,
`kelim` and whether the new starting points vastly differ from those in the
starting points based on the data.

For this I will just use the PK object I have saved `my_pk` and take the
_prefit_ parameter estimations and first compare that with eventual optimized `kelim`.

```{r kelim-questions}

# Original data, filtered for common_chems
# par_DF
my_kelim_prefit <- my_pk$prefit$par_DF %>%
  filter(param_name %in% "kelim",
         Chemical %in% common_chems) %>%
  distinct(Chemical, Species, param_name, lower_bound, upper_bound, start)

my_kelim_fit <- coef(my_pk) %>%
  inner_join(get_winning_model(my_pk)) %>%
  ungroup() %>%
  distinct(model, Chemical, Species, kelim) %>%
  rename(fit_kelim = "kelim") %>%
  filter(Chemical %in% common_chems)

my_kelim_df <- inner_join(my_kelim_fit, my_kelim_prefit)


httk_df <- rest_pk$prefit$par_DF %>%
  filter(param_name %in% "kelim") %>%
  distinct(Chemical, Species, param_name, start) %>%
  rename(init_restrictive = "start") %>%
  inner_join(
    nonrest_pk$prefit$par_DF %>%
  filter(param_name %in% "kelim") %>%
  distinct(Chemical, Species, param_name, start) %>%
  rename(init_nonrestrictive = "start"))


full_df <- inner_join(my_kelim_df, httk_df) %>%
  relocate(fit_kelim, .after = last_col())


full_df %>%
  ggplot(aes(x = Chemical)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "grey30") +
  geom_errorbar(aes(ymax = upper_bound, ymin = lower_bound)) +
  geom_point(aes(y = fit_kelim, color = "Original Optimized")) +
  geom_point(aes(y = init_restrictive, color = "Restrictive")) +
  geom_point(aes(y = init_nonrestrictive, color = "Non-restrictive")) +
  geom_point(aes(y = start, shape = "Original Initialized")) +
  facet_grid(rows = vars(Species), scales = "free", space = "free") +
  scale_color_manual(name = "kelim",
                     breaks = c("Original Optimized", "Restrictive", "Non-restrictive"),
                     values = c("Original Optimized" = "skyblue4", 
                                "Restrictive" = "orange2",
                                "Non-restrictive" = "green4")) +
  scale_shape_manual(name = "",
                     values = 4) +
  coord_flip() +
  scale_y_log10(labels = scales::label_math(format = log10)) +
  theme(panel.border = element_rect(color = "black", fill = NA, linewidth = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        legend.direction = "vertical",
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text.y = element_blank(),
        strip.text.y = element_text(angle = 0))


ggsave(filename = paste0(Sys.getenv("FIG_DIR"), "kelim_compare_2024_0329.png"),
       height = 11,
       width = 8.5)


```



```{r}

new_wm <- get_winning_model(new_pk)
new_AIC <- AIC(new_pk)
new_rsq <- rsq(new_pk)

new_tkstats <- eval_tkstats(new_pk, finite_only = FALSE)


residuals(new_pk) %>% View()



pl <- plot(new_pk, n_interp = 12, use_scale_conc = TRUE, best_fit = TRUE)
pdf(file = paste0(Sys.getenv("FIG_DIR"),
              "BestFits_Final_2024_0405.pdf"),
    height = 6, width = 10)
for (i in 1:nrow(pl)) {
  print(pl$final_plot[[i]])
}
dev.off()


```

Comparing total clearance estimates for those where a restrictive or non-restrictive model
was the "best fit" as determined by AIC.

```{r cltot-comparison}
new_cltot2 <- new_tkstats %>% 
  # filter(str_detect(model, "rest")) %>%
  select(Chemical, Species, Media, Route, 
         model, method,
         CLtot.tkstats, CLtot.nca) %>%
  filter(!is.na(CLtot.tkstats)) %>%
  mutate(clearance_type = ifelse(str_detect(model, "nonrest"),
                                "NonRestrictive",
                                ifelse(str_detect(model, "rest"),
                                       "Restrictive",
                                       "optimized kelim"))) %>%
  rowwise() %>%
  mutate(CLtot.httk_rest = calc_total_clearance(dtxsid = Chemical,
                                           restrictive.clearance = TRUE),
         CLtot.httk_nonrest = calc_total_clearance(dtxsid = Chemical,
                                           restrictive.clearance = FALSE))



new_cltot2 %>%
  ggplot(aes(x = Chemical)) +
  geom_point(aes(y = CLtot.httk_rest),shape = 19, size = 2, color = "green4") +
  geom_point(aes(y = CLtot.httk_nonrest),shape = 19, size = 2, color = "orange2") +
  geom_point(aes(y = CLtot.tkstats), shape = 1, size = 3, color = "black", stroke = 1) +
  scale_y_log10(labels = scales::label_math(format = log10)) +
  geom_hline(yintercept = c(0.01, 0.1, 1, 10)) +
  coord_flip() +
  facet_grid(rows = vars(clearance_type),
             scales = "free", space = "free") +
  labs(title = "Total Clearance for constant kelim \"best fits\" (empty)\nand httk calculations (filled)") +
  theme_bw() +
  theme(axis.line = element_line(linewidth = 1),
        axis.text = element_text(size = 12),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        plot.background = element_rect(fill = "white"))

ggsave(filename = paste0(Sys.getenv("FIG_DIR"), "Cltot_backcompare_2024_0405.png"),
       height = 4,
       width = 6)


```

```{r chemical-correlation}
new_AIC %>%
  ungroup() %>%
  filter(model %in% c("model_1comp", "model_2comp"),
         Species %in% "rat") %>%
  group_by(Chemical) %>%
  filter(AIC == min(AIC)) %>%
  mutate(estimate = "nonConst") %>%
  distinct(Chemical, model, estimate) -> nAIC_nonConst
new_AIC %>%
  ungroup() %>%
  filter(model %in% c("model_1comp_rest", "model_2comp_rest"),
         Species %in% "rat") %>%
  group_by(Chemical) %>%
  filter(AIC == min(AIC)) %>%
  mutate(estimate = "Rest") %>%
  distinct(Chemical, model, estimate) -> nAIC_rest
new_AIC %>%
  ungroup() %>%
  filter(model %in% c("model_1comp_nonrest", "model_2comp_nonrest"),
         Species %in% "rat") %>%
  group_by(Chemical) %>%
  filter(AIC == min(AIC)) %>%
  mutate(estimate = "nonRest") %>%
  distinct(Chemical, model, estimate) -> nAIC_nonrest

full_nAIC <- bind_rows(nAIC_nonConst, nAIC_rest) %>%
  bind_rows(nAIC_nonrest)

new_tkstats_full <- get_tkstats(new_pk)

new_tkstats_full %>%
  filter(Species %in% "rat", !(model %in% "model_flat")) %>%
  distinct(Chemical, model, CLtot) %>%
  inner_join(full_nAIC) %>%
  na.omit() %>% 
  distinct(Chemical, estimate, CLtot) %>%
  pivot_wider(names_from = estimate,
              values_from = CLtot) %>%
  rowwise() %>%
  mutate(CLtot.httk_rest = calc_total_clearance(dtxsid = Chemical,
                                           restrictive.clearance = TRUE),
         CLtot.httk_nonrest = calc_total_clearance(dtxsid = Chemical,
                                           restrictive.clearance = FALSE)) %>%
  ungroup() %>%
  mutate(A_rest = log(nonConst) - log(CLtot.httk_rest),
         A_nonrest = log(nonConst) - log(CLtot.httk_nonrest),
         B_rest = log(Rest) - log(CLtot.httk_rest),
         B_nonrest = log(Rest) - log(CLtot.httk_nonrest),
         C_rest = log(nonRest) - log(CLtot.httk_rest),
         C_nonrest = log(nonRest) - log(CLtot.httk_nonrest)) %>%
  select(Chemical, A_rest:C_nonrest) -> df_valcomp

df_valcomp %>% 
  column_to_rownames(var = "Chemical") %>%
  t() %>%
  as.matrix() %>%
  cor() %>%
  round(digits = 3) -> val_cormat

hclust(d = as.dist(1-abs(val_cormat)), method = "complete") %>% plot()

hclust(d = as.dist(1-abs(val_cormat)), method = "complete") -> val_hclust

corrplot::corrplot(abs(val_cormat))

#reorder the Chemical names prior to plotting
df_valcomp %>%
  mutate(Chemical = factor(x = Chemical,
                           levels = val_hclust$labels[val_hclust$order])) %>%
  pivot_longer(cols = A_rest:C_nonrest,
               names_to = "comparison", values_to = "logres") %>%
  mutate(comparison = case_when(
    comparison == "A_nonrest" ~ "free kelim vs httk nonrestrictive",
    comparison == "A_rest" ~ "free kelim vs httk restrictive",
    comparison == "B_nonrest" ~ "restrictive kelim vs httk nonrestrictive",
    comparison == "B_rest" ~ "restrictive kelim vs httk restrictive",
    comparison == "C_nonrest" ~ "nonrestrictive kelim vs httk nonrestrictive",
    comparison == "C_rest" ~ "nonrestrictive kelim vs httk restrictive",
  ),
  comparison = factor(comparison,
  levels = c("free kelim vs httk nonrestrictive",
             "free kelim vs httk restrictive",
             "restrictive kelim vs httk nonrestrictive",
             "restrictive kelim vs httk restrictive",
             "nonrestrictive kelim vs httk nonrestrictive",
             "nonrestrictive kelim vs httk restrictive"))) %>%
  ggplot(aes(x = comparison, y = Chemical, fill = logres)) +
  geom_tile() +
  scale_fill_gradient2(mid = "grey5", high = "magenta", low = "green",
                       name = "Total Clearance\nlog-scale difference") +
  coord_fixed(ratio = 0.3) +
  theme_bw() +
  theme(axis.text.x = element_text(hjust = 1, angle = 45),
        axis.ticks.y = element_blank(),
        panel.grid = element_blank(),
        axis.title.x = element_blank())

ggsave(filename = paste0(Sys.getenv("FIG_DIR"), "Cltot_compare_heatmap_2024_0405.png"),
       height = 14,
       width = 8)

```



```{r dawson}
# try dawson
httk::load_dawson2021()

```

