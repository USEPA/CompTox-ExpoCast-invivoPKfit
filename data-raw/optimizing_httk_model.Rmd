---
title: "Optimizing httk's 3comp2 model"
author: "Gilberto Padilla Mercado"
date: "2025-05-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
devtools::load_all()
library(httk)
```

# Purpose

This documents how to optimize `Clint` and `Funbound.plasma` using
_invivoPKfit_ and _httk_'s `3compartment2` model. There are
a couple of issues mainly stemming from the fact that the solver often
returns an error from the underlying FORTRAN code used in `deSolve` in
multiple iterations of the optimization procedure.

```{r}
load_dawson2021()
schems <- httk::get_cheminfo("dtxsid", species = "rat",
                             model = "3compartment2")[50:65] |>
  suppressWarnings()

sum(unique(cvt$analyzed_chem_dtxsid) %in% schems)

minicvt <- subset(
  cvt,
  species == "rat" &
    analyzed_chem_dtxsid %in% schems
)

table(minicvt$analyzed_chem_dtxsid)
```

First I want to try just the clearance-aware 1-compartment models


```{r}
test_pk <- pk(data = minicvt) + 
  stat_error_model(error_group = vars(Chemical, Species)) +
  stat_model(model = c("model_flat", "model_1comp_cl_rest",
                       "model_1comp_cl_nonrest", "model_1comp_fup")) +
  settings_optimx(hessian = TRUE) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE)

test_pk <- do_prefit(test_pk)
test_pk
gc()

test_fit <- do_fit(test_pk)
winmodel <- get_winning_model(test_fit)
View(winmodel)

pl <- plot(test_fit, use_scale_conc = TRUE, method = "bobyqa",best_fit = TRUE)
pl$final_plot[[1]]
pl$final_plot[[2]]
pl$final_plot[[3]]
pl$final_plot[[4]]

get_fit(test_fit) |> dplyr::filter(Chemical == "DTXSID4020458",
                                   param_name %in% c("Fup", "Clint"),
                                   model != "model_flat",
                                   convcode == 0) |>
  View()

```


We have a list of things to try:

[] Are the timepoints causing issues? Run and stop with initial parameters.
[] Should we only optimize one parameter? Modify `get_params_httk_3comp2` function.



```{r}

test_pk <- pk(data = minicvt) + 
  stat_error_model(error_group = vars(Chemical, Species)) +
  stat_model(model = c("model_flat", "model_httk_3comp2")) +
  settings_optimx(hessian = TRUE) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE)

test_pk <- do_prefit(test_pk)
test_pk
gc()

test_fit <- do_fit(test_pk)

```

```{r}
preds <- predict(test_fit)

my_fit <- get_fit(test_fit) |>
  dplyr::filter(optimize_param)

View(transform(my_fit, opt_diff = start - estimate))

```

