---
title: "Untitled"
output: html_document
date: "2024-08-12"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
set.seed(2023)
library(tidyverse, quietly = TRUE)
devtools::load_all() 
library(cowplot)
library(RColorBrewer)
# saveRDS(my_pk, "data-raw/all_cvt_pk_JOINT.rds")
# my_pk <- readRDS("data-raw/all_cvt_pk_JOINT.rds")

```

Set data directory

```{r}
datadir <- "C:/Users/cring/OneDrive - Environmental Protection Agency (EPA)/invivopkfit work/fitfiles"
```


```{r, eval = FALSE}
### Minimal PK Object ###----
# Minimum pk object, add options later
# Note that these mappings are now a default mappings, just being verbose here.
minimal_pk <- pk(data = cvt,
                 mapping = ggplot2::aes(
                   Chemical = analyte_dtxsid,
                   Chemical_Name = analyte_name_original,
                   DTXSID = analyte_dtxsid,
                   CASRN = analyte_casrn,
                   Species = species,
                   Reference = document_id,
                   Media = conc_medium_normalized,
                   Route = administration_route_normalized,
                   Dose = dose_level_normalized,
                   Dose.Units = "mg/kg",
                   Subject_ID = subject_id,
                   Series_ID = series_id,
                   Study_ID = study_id,
                   ConcTime_ID = conc_time_id,
                   N_Subjects = n_subjects_in_series,
                   Weight = weight_kg,
                   Weight.Units = "kg",
                   Time = time_hr,
                   Time.Units = "hours",
                   Value = conc,
                   Value.Units = "mg/L",
                   Value_SD = conc_sd_normalized,
                   LOQ = loq
                 ))
```

```{r, eval = FALSE}
my_pk_000p <- pk(data = cvt,
                 mapping = ggplot2::aes(
                   Chemical = analyte_dtxsid,
                   Chemical_Name = analyte_name_original,
                   DTXSID = analyte_dtxsid,
                   CASRN = analyte_casrn,
                   Species = species,
                   Reference = document_id,
                   Media = conc_medium_normalized,
                   Route = administration_route_normalized,
                   Dose = dose_level_normalized,
                   Dose.Units = "mg/kg",
                   Subject_ID = subject_id,
                   Series_ID = series_id,
                   Study_ID = study_id,
                   ConcTime_ID = conc_time_id,
                   N_Subjects = n_subjects_in_series,
                   Weight = weight_kg,
                   Weight.Units = "kg",
                   Time = time_hr,
                   Time.Units = "hours",
                   Value = conc,
                   Value.Units = "mg/L",
                   Value_SD = conc_sd_normalized,
                   LOQ = loq
                 )) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = FALSE,
                      suppress.messages = FALSE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = FALSE, log10_trans = FALSE) +
  stat_error_model(error_group = vars(Chemical, Species)) 
```

```{r, eval = FALSE}
system.time(my_pk_000p <- do_fit(my_pk_000p, n_cores = 12))
```

We want to do the following by data group (Chemical, Species):

1. Get the winning model
2. Get tkstats
3. Get goodness of fit metrics: RMSE, R-squared, AIC

```{r, eval = FALSE}
this_win_model <- get_winning_model(my_pk_000p)
```



```{r, eval = FALSE}
this_rsq <- rsq(my_pk_000p,
                use_scale_conc = FALSE) #get rsq in original concentration units
```

Filter Rsq for the winning models only

```{r, eval = FALSE}
this_rsq_win <- dplyr::inner_join(this_rsq,
                                  this_win_model)
```

```{r, eval = FALSE}
ggplot(this_rsq_win) + geom_violin(aes(x = method, y = Rsq))
```


```{r, eval = FALSE}
this_tkstats_dose_norm <- get_tkstats(my_pk_000p,
                            dose_norm = TRUE,
                            tk_group = vars(Chemical, Species, Reference, Route, Media, Dose))
```

```{r, eval = FALSE}
this_tkstats_dose_norm_win <- dplyr::inner_join(this_tkstats_dose_norm,
                                                this_win_model)
```
Pivot the tkstats longer

```{r, eval = FALSE}
this_tkstats_long <- tidyr::pivot_longer(data = this_tkstats_dose_norm_win,
                    cols = -any_of(c(names(my_pk_000p$data),
                                     "model",
                                     "method")))
```




```{r, eval = FALSE}
this_nca_dose_norm <- nca(my_pk_000p,
                          nca_group = vars(Chemical, Species, Reference, Route, Media, Dose),
                          dose_norm = TRUE)
```

```{r, eval = FALSE}
this_tkstats_long <- this_tkstats_long %>% 
  dplyr::rename(param_name = name,
                tkstats_value = value) %>%
  dplyr::mutate(tkstats_dose_norm = TRUE,
                tkstats_value = dplyr::if_else(is.finite(tkstats_value),
                                           tkstats_value,
                                           NA_real_))

this_nca_dose_norm <- this_nca_dose_norm %>%
  dplyr::rename(nca_value = param_value,
                nca_dose_norm = dose_norm,
                nca_design = design) %>%
  dplyr::mutate(nca_value = dplyr::if_else(is.finite(nca_value),
                                           nca_value,
                                           NA_real_)) %>%
    dplyr::mutate(nca_value = dplyr::if_else(abs(nca_value) < 1e8,
                                           nca_value,
                                           NA_real_)) %>%
  dplyr::select(-param_sd_z)
```


Merge the TK stats and the NCA, keeping only the ones with matches in both

```{r, eval = FALSE}
tkstats_nca <- inner_join(this_tkstats_long,
                          this_nca_dose_norm,
                          by = join_by(Chemical,
                                       Species,
                                       Reference,
                                       Route,
                                       Media,
                                       param_name
                                       ))
```
Calculate differences 

```{r, eval = FALSE}
tkstats_nca_summary <- tkstats_nca %>%
  dplyr::group_by(method, param_name) %>%
  dplyr::summarise(rmse = sqrt(mean((tkstats_value - nca_value)^2,
                                    na.rm = TRUE)))
```

# Loop over fitting options

```{r}
#set up table of fitting options
fitopts <- expand.grid(error_model = c("pooled",
                                       "hierarchical"),
                       dose_norm = c(TRUE, FALSE),
            log10_trans = c(TRUE, FALSE),
            time_scale = c(TRUE, FALSE),
            stringsAsFactors = FALSE)

```

There are 16 combinations of fitting options. At about 1000 seconds per combination, this means it will take about 16000 seconds, or about 4.5 hours, to run them all. Maybe a little longer.

Function to loop over fitting options

```{r, eval = FALSE}
fit_data <- function(this_error_model,
                     this_dose_norm,
                     this_log10_trans,
                     this_time_scale,
                     n_cores = 12){
  retval <- -9
   dose_indic <- as.numeric(this_dose_norm)
  log10_indic <- as.numeric(this_log10_trans)
  time_indic <- as.numeric(this_time_scale)
  errmodel_indic <- substr(this_error_model, 1, 1)
  
  file_str <- paste0("pkfit_",
                     dose_indic,
                     log10_indic,
                     time_indic,
                     errmodel_indic,
                     ".Rds")
  
  print(file_str)
  
  tryCatch({
  this_pk <-   minimal_pk +
    facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = FALSE,
                      suppress.messages = TRUE) +
     scale_conc(dose_norm = this_dose_norm, log10_trans = this_log10_trans) +
    settings_optimx(method = c("L-BFGS-B", "bobyqa"))
  
  if(this_error_model %in% "pooled"){
    this_pk <- this_pk +
      stat_error_model(error_group = vars(Chemical, Species)) 
  } else if(this_error_model %in% "hierarchical"){
    this_pk <- this_pk +
      stat_error_model(error_group = vars(Chemical, Species, Reference)) 
  } else{
    stop("this_error_model must be either 'pooled' or 'hierarchical'")
  }
  
  if(this_time_scale %in% TRUE){
    this_pk <- this_pk +
      scale_time(new_units = "auto")
  }
  
  #do the fit
  this_time <- system.time(this_fit <- do_fit(this_pk, n_cores = n_cores))
  
  print(this_time)
  
  #save the result
  saveRDS(this_fit,
          paste0(datadir, "/",
                 file_str))
  retval <- 0
  },
  error = function(e){
    message(paste("Analysis",
                  file_str,
                  "failed with error",
                  e))
    retval <- -1
  }
)
  
  return(retval)
}

```


```{r, eval = FALSE}
system.time(tmp <- mapply(fit_data,
              this_error_model = fitopts$error_model,
                     this_dose_norm = fitopts$dose_norm,
                     this_log10_trans = fitopts$log10_trans,
                     this_time_scale = fitopts$time_scale))
```

# Compare R-squared

Load in each fitted pk object in turn, and calculate R-squared.

```{r}
get_gof_win <- function(this_error_model,
                     this_dose_norm,
                     this_log10_trans,
                     this_time_scale){
   dose_indic <- as.numeric(this_dose_norm)
  log10_indic <- as.numeric(this_log10_trans)
  time_indic <- as.numeric(this_time_scale)
  errmodel_indic <- substr(this_error_model, 1, 1)
  
  file_str <- paste0("pkfit_",
                     dose_indic,
                     log10_indic,
                     time_indic,
                     errmodel_indic,
                     ".Rds")
  
  this_pk <- readRDS(paste0(datadir, "/",
                 file_str))
  
  this_rsq <- rsq(this_pk,
                  rsq_group = vars(Chemical, Species))
  this_rmse <- rmse(this_pk,
                    rmse_group = vars(Chemical, Species))
  
  this_aic <- AIC(this_pk)
  
  this_win <- get_winning_model(this_pk)
  this_win <- this_win %>% dplyr::mutate(winning_model = TRUE)
  
  this_gof <- dplyr::left_join(
    dplyr::left_join(this_rsq,
                              this_aic),
    this_rmse)
  
  this_gof_win <- dplyr::left_join(this_gof,
                               this_win,
                              by = join_by(Chemical, Species, method, model))
  
  return(this_gof_win)
  
}
```

```{r}
system.time(gof_tbl <- fitopts %>%
              dplyr::rowwise() %>%
              dplyr::mutate(gof_win = list(get_gof_win(this_error_model = error_model,
                                                  this_dose_norm = dose_norm,
                                                  this_log10_trans = log10_trans,
                                                  this_time_scale = time_scale))) %>%
              tidyr::unnest(gof_win))
```

Plot

Distributions of R-squared values (for winning models) across data groups (Chemical + Species), by combinations of fitting options. I chose R-squared here because it's on the same scale across data groups, unlike RMSE or even AIC.

```{r}
ggplot(gof_tbl[winning_model %in% TRUE]) +
  geom_violin(x = interaction(error_model,
                              dose_norm,
                              log10_trans,
                              time_scale),
              y = Rsq)
```
















