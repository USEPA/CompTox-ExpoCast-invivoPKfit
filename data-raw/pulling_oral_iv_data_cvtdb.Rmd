---
title: "Pulling oral and IV data from CvTdb"
author: "Caroline Ring, Gilberto Padilla Mercado"
date: "2023-09-29"
output: 
  html_document:
    toc: true
  pdf_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = NA,
                      tidy.opts = list(width.cutoff = 75),
                      tidy = TRUE)
```

Load necessary packages: **DBI, dplyr, tidyr**

```{r}
library(DBI)
devtools::load_all() # So this loads the previous cvt object
library(dplyr)
library(tidyr)
library(readr)
```


# Connect to database

This section is largely taken from a `Querying CvTdb` vignette from Taylor Wall 
and a previous version of this vignette authored by Caroline Ring.  

For connection to CvTdb:

Connect to EPA VPN.

Set environment variables for the user name, password, host, and dbname that will be used to connect. Doing it this way allows us to not hardcode the password.

The following are some helper functions for the database connection.

```{r query_functions}
postgreSQL_connection <- function() {
  return(
    dbConnect(RPostgreSQL::PostgreSQL(),
              user = Sys.getenv("CVT_USER"),
              password = Sys.getenv("CVT_PASS"),
              host = Sys.getenv("CVT_HOST"),
              dbname = Sys.getenv("CVT_DB_NAME"))
  )
}

query_db <- function(query = NULL, schema) {
  if (is.null(query)) return(cat("\nMust provide a query to send"))
  con <- postgreSQL_connection()
  
  query_result <- tryCatch(
    return(dbGetQuery(con, query %>%
                        gsub("FROM ", paste0("FROM ", schema, "."), .) %>%
                        gsub("JOIN (?=\\w)", paste0("JOIN ", schema, "."), ., 
                             perl = TRUE))),
  error = function(cond){ 
    cat(paste0("\nError message: ", cond))
    return(NULL)
  },
  finally = { 
    dbDisconnect(con)
    }
    )
  return(query_result)
}

```

```{r quick_message_funtion}
quick_message <- function(text = character()) {
  stopifnot(length(text) > 0)
  
  cli::cli_par()
  cli::cli_text(paste("{.strong [i]}  ", text[1], sep = "\t"))
  text <- text[-1]
  
  for (this_text in seq_along(text)) {
    cli::cli_li(text[this_text])
  }
  cli::cli_end()

}

quick_stats <- function(.data, old_version = FALSE) {
  stopifnot(is.data.frame(.data))
  
  cli::cli_h2("Statistics on the current data")
  message(paste0("Total number of data points: ", nrow(.data)))
  message("Unique Species and data counts:")
  print(table(.data$species))
  
  message("Number of unique studies: ",
          length(unique(.data$fk_study_id)))
  message("Number of unique series: ",
          length(unique(.data$fk_series_id)))
  
  if (old_version) {
    message("Number of unique chemicals: ",
          length(unique(.data$analyte_dtxsid)),
          "\n")
    chem_by_medium <- .data[c("conc_medium_normalized", "analyte_dtxsid")] %>%
      filter(!is.na(analyte_dtxsid)) %>%
      distinct()
    chem_by_curset <- .data[c("curation_set_tag", "analyte_dtxsid")] %>%
      filter(!is.na(analyte_dtxsid)) %>%
      distinct()
  } else {
    message("Number of unique chemicals: ",
          length(unique(.data$analyzed_chem_dtxsid)),
          "\n")
    chem_by_medium <- .data[c("conc_medium_normalized", "analyzed_chem_dtxsid")] %>%
      filter(!is.na(analyzed_chem_dtxsid)) %>%
      distinct()
    chem_by_curset <- .data[c("curation_set_tag", "analyzed_chem_dtxsid")] %>%
      filter(!is.na(analyzed_chem_dtxsid)) %>%
      distinct()
  }
  
  message("Unique Dose units: ",
          toString(unique(.data$dose_level_units_original)),
          "\n")
  if (all(is.na(.data$conc_units_normalized))) {
    message("Unique Concentration units: ", 
            toString(unique(.data$conc_units_original)),
            "\n")
  } else {
    message("Unique Concentration units: ", 
            toString(unique(.data$conc_units_normalized)),
            "\n")
  }
  message("Data by unique route of administration:")
  print(table(.data$administration_route_normalized))
  message("Data by medium collected:")
  print(table(.data$conc_medium_normalized))
  message("Data by curation set:")
  print(table(.data$curation_set_tag))
  message("\n\nUnique chemicals per medium:")
  print(table(chem_by_medium$conc_medium_normalized))
  message("Unique chemicals per curation set:")
  print(table(chem_by_curset$curation_set_tag))
}

```


```{r diff_log_function}
# Now I want to write a quick function that will log relevant changes
# from previous 'cvt' objects
diff_log_cvt <- function(new_cvt,
                         key_id = "conc_time_id",
                         grp_ids = c("analyzed_chem_dtxsid",
                                     "species"),
                         notes = character(0L)) {
  stopifnot(
    key_id %in% colnames(cvt),
    key_id %in% colnames(new_cvt),
    all(grp_ids %in% colnames(cvt)),
    all(grp_ids %in% colnames(new_cvt))
  )
  if (length(unique(new_cvt[[key_id]])) != NROW(new_cvt)) {
    stop("key_id is not not a column that uniquely identifies this data.")
  }
  
  # Prepare some vectors:
  grp_strings_new <- unique(do.call("paste", new_cvt[grp_ids]))
  grp_strings_old <- unique(do.call("paste", cvt[grp_ids]))
  
  msg_to_write <- paste0("\n\n======== ", round(Sys.time()))
  
  if (identical(new_cvt, cvt)) {
    msg_to_write <- paste(msg_to_write, "No changes.", sep = "\t")
    message("There are no changes from previous `cvt` data.frame, ",
            "are you sure you want to save this?")
  } else {
    msg_to_write <- paste(msg_to_write, "Changes detected.", sep = "\t")
    
    ###---- Check key_id changes (usually conc_time_id)
    diff_row_add <- setdiff(new_cvt[[key_id]], cvt[[key_id]])
    diff_row_sub <- setdiff(cvt[[key_id]], new_cvt[[key_id]])
    diff_row_common <- intersect(cvt[[key_id]], new_cvt[[key_id]])
    # Nature of data changes:
    added_grps <- unique(
      do.call("paste",
              new_cvt[which(new_cvt[[key_id]] %in% diff_row_add), grp_ids]
              )
      )
    removed_grps <- unique(
      do.call("paste",
              cvt[which(cvt[[key_id]] %in% diff_row_sub), grp_ids]
              )
      )
    
    added_new_grps <- setdiff(added_grps, grp_strings_old)
    added_existing_grps <- intersect(added_grps, grp_strings_old)
    removed_new_grps <- setdiff(removed_grps, grp_strings_new)
    removed_existing_grps <- intersect(removed_grps, grp_strings_new)
    
    
    msg_to_write <- c(
      msg_to_write,
      paste("Rows added:", length(diff_row_add)),
      paste("Rows removed:", length(diff_row_sub))
    )
    
    limit_grp_output <- function(grp_vector) {
      if (length(grp_vector) > 0) {
        if (length(grp_vector) > 6) {
          grp_vector <- c(grp_vector[c(1,2)],
                              paste0("... [",
                                     length(grp_vector) - 3,
                                     "] more!"),
                              grp_vector[c(length(grp_vector) - 1)]
          )
        }
      return(grp_vector)
    }
      msg_to_write <- c(msg_to_write,
                        "New Groups added (not in previous data):",
                        paste0("\t", limit_grp_output(added_new_grps)),
                        "Groups with new observations (group present in previous data)",
                        paste0("\t", limit_grp_output(added_existing_grps)),
                        "Groups removed that no longer have data present:",
                        paste0("\t", limit_grp_output(removed_new_grps)),
                        "Groups removed that still have some data present:",
                        paste0("\t", limit_grp_output(removed_existing_grps)),
                        "-----------------------------------"
                        )
    }
    
    ### -----Checking columns
    diff_col_add <- setdiff(names(new_cvt), names(cvt)) # Columns added in new_cvt
    diff_col_sub <- setdiff(names(cvt), names(new_cvt)) # Columns removed in new_cvt
    diff_col_common <- intersect(names(cvt), names(new_cvt))
    common_row_cvt <- cvt[cvt[[key_id]] %in% diff_row_common, ]
    
    common_row_cvt <- common_row_cvt[order(common_row_cvt[[key_id]]), ]
    
    common_row_new <- new_cvt[new_cvt[[key_id]] %in% diff_row_common, ]
    common_row_new <- common_row_new[order(common_row_new[[key_id]]), ]
    
    if (length(c(diff_col_add, diff_col_sub)) == 0) {
      msg_to_write <- c(msg_to_write,
                        "No changes in column names.")
    } else if (length(diff_col_add) > 0 && length(diff_col_sub) > 0) {
      # Check renaming
      
      diff_columns <- function(x, y) {
        out_list <- character()
        for (ix in setdiff(names(x), key_id)) {
          for (iy in setdiff(names(y), key_id)) {
            tmp <- merge(x[c(key_id,ix)], y[c(key_id, iy)], by=key_id)
            if (identical(tmp[[2]], tmp[[3]])) {
              out_list <- c(out_list, paste0(ix, " -> ", iy))
            }
          }
        }
        return(out_list)
      }
      
      renamed_cols <- diff_columns(common_row_cvt[c(key_id,diff_col_sub)],
                                   common_row_new[c(key_id, diff_col_add)])
      if (length(renamed_cols) > 0) {
        msg_to_write <- c(msg_to_write,
                          "Renamed columns (non-exhaustive):",
                          renamed_cols)
      } else {
        msg_to_write <- c(msg_to_write,
                          "No renamed columns found.")
      }
    }
    if (length(diff_col_add) > 0) {
      msg_to_write <- c(msg_to_write,
                        "--------------",
                        "Columns added:",
                        diff_col_add)
    }
    if (length(diff_col_sub) > 0) {
      msg_to_write <- c(msg_to_write,
                        "______________",
                        "Columns removed (from previous data):",
                        diff_col_sub)
    }
    
    if ((NROW(
      setdiff(
        common_row_cvt[diff_col_common], common_row_new[diff_col_common]
      )) > 0
    ) ||  (NROW(
      setdiff(
        common_row_new[diff_col_common], common_row_cvt[diff_col_common]
      )) > 0
    )) {
      msg_to_write <- c(msg_to_write,
                        "Data for same observation key_ids have changed.")
      
      # Which columns have different data?
      test_cols <- setdiff(diff_col_common, key_id)
      for (i in test_cols) {
        this_diff <- setdiff(common_row_new[c(key_id, i)],
                             common_row_cvt[c(key_id, i)])
        that_diff <- setdiff(common_row_cvt[c(key_id, i)],
                             common_row_new[c(key_id, i)])
        
        if (NROW(this_diff) > 0) {
          msg_to_write <- c(
            msg_to_write,
            paste0(c(i, "had", NROW(this_diff), "differences."), collapse = " ")
          )
          
          this_grp <- dplyr::distinct(common_row_new[
            common_row_new[[key_id]] %in% this_diff[[key_id]],
            grp_ids
          ])
          this_grp <- paste0(this_grp[1,1:2], collapse = " ")
          
          # Print the differences (if below a certain number of rows)
          msg_to_write <- c(
            msg_to_write,
            paste0(
              "Example:",
              paste(this_grp, collapse = " "),
              collapse = " "
            ),
            paste0(c(i, "\t new:", this_diff[1,2], "<--\t old:", that_diff[1,2]),
                   collapse = " "), "\n"
          )
        }
      }
    }
    msg_to_write <- c(msg_to_write,
                      notes,
                      "================================\n")
  }
  return(cat(msg_to_write, sep = "\n"))
}

```

# SQL Query

The SQL query result is built by left joining onto the `conc_time_values` table.
Additionally, because _invivoPKfit_ uses DTXSID as the standard chemical identifier,
it is important to repair some missing values for DTXSID. To do this, I 
make a separate query `SELECT distinct * FROM chemicals` and making the chemical
names to lowercase and by specifically taking the columns for name (now lowercase)
and DTXSID, I can see there are many instances of duplicated chemical entries
(which means they have separate `chemical.id` key values in this table). I then
"fill in" the DTXSID when they are missing and if any other instance of that
chemical name in the table has a DTXSID. I fill in DTXSIDs in the main
query result that I will be using using some joins with this repaired table.

## Suggestions for CvTdb  

Repairing duplication in the chemicals table should be a priority
that would benefit all current and future users of _CvTdb_. It would repair other
missing identifying chemical information as well as truly have unique rows per chemical.
Here this repair is done by making names lowercase to avoid capitalization, but there
may be other issues arise with spaces that should be parsed prior to input into 
the database record.  

The other suggestion would be to have a filled out `conc_units_normalized` column in
the `series` table. Although it is assumed to be _mg/kg_, it would be nice to have this
confirmed. Here `conc_units_original` is compared with the ratio of `conc` to `conc_original`
to get a sense of whether the units for `conc` were reasonably converted to
_mg/kg_. This seems like it could reasonably be a part of the QA process.  

Besides these two suggestions, there are only a couple other changes in the data that 
are made throughout this document but these pertain to specific records rather than
the entire database, so I think they are a little bit lower on the priority list.


```{r SQL_queries, warning=FALSE}
# Need to make this in a specified ordered
# First all IDs (so I can check them quickly)
# Note that this uses an ALIAS for each table which is later specified in
# the FROM and LEFT JOIN statements
series_chems <- paste0(
  "SELECT DISTINCT a.id, a.fk_analyzed_chemical_id, ",
  "b.analyzed_chem_dtxsid, b.analyzed_chem_name_original, ",
  "b.analyzed_chem_name_secondary_original, ",
  "b.analyzed_chem_casrn, b.analyzed_chem_name, ",
  "a.time_units_original, a.conc_units_original, ",
  "a.conc_units_normalized, a.loq, a.loq_units, ",
  "a.n_subjects_in_series, a.radiolabeled, a.fk_study_id, ",
  "a.qc_notes, a.qc_status, a.qc_flags, c.conc_medium_normalized ",
  "FROM series a ",
  "LEFT JOIN (SELECT id, dsstox_substance_id as analyzed_chem_dtxsid, ",
  "chemical_name_original as analyzed_chem_name_original, ",
  "chemical_name_secondary_original as analyzed_chem_name_secondary_original, ",
  "dsstox_casrn as analyzed_chem_casrn, preferred_name as analyzed_chem_name ",
  "FROM chemicals) as b ON a.fk_analyzed_chemical_id = b.id ",
  "LEFT JOIN conc_medium_dict as c ON a.fk_conc_medium_id = c.id"
)

study_docs <- paste0(
  "SELECT a.id, a.fk_extraction_document_id, a.fk_dosed_chemical_id, ",
  "b.pmid, b.doi, b.year, b.other_study_identifier, ",
  "b.url, b.extracted, b.curation_set_tag ",
  "FROM studies a ",
  "LEFT JOIN documents b ON a.fk_extraction_document_id = b.id"
)

audit_query <- query_db(paste0("SELECT DISTINCT * FROM cvt_audit ",
                               "WHERE fk_table_name IN ('documents', 'series', 'studies')"),
                        "cvt")
study_query <- query_db(study_docs, "cvt")
series_query <- query_db(series_chems, "cvt")
dtxsid_query <- query_db("SELECT DISTINCT * FROM chemicals", "cvt") %>%
  mutate(
    across(ends_with("id"), as.character),
    across(contains("chemical_name"), \(x) {
      tolower(force_ascii_quotes(x))
    })
  )
  
# There are a lot of duplicate DTXSIDs
query <- paste0(
  "SELECT distinct ",
  # Conc_Time_Values table fields
  "a.id, a.fk_series_id, a.time_original, a.time_hr, ",
  "a.conc_original, a.conc_sd_original, a.conc, a.conc_sd, ",
  
  # Series table fields
  "b.fk_analyzed_chemical_id, ",
  ## Chemical dictionary fields (analyzed chemical information)
  "l.analyzed_chem_dtxsid, l.analyzed_chem_name_original, ",
  "l.analyzed_chem_casrn, l.analyzed_chem_name, ",
  
  "b.time_units_original, b.conc_units_original, ",
  "b.conc_units_normalized, b.loq, b.loq_units, ",
  "b.n_subjects_in_series, b.radiolabeled, b.fk_study_id, ",
  
  # Studies table fields
  "c.fk_dosed_chemical_id, ",
  ## Chemical dictionary fields (dosed chemical information)
  "k.dosed_chem_dtxsid, k.dosed_chem_name_original, ",
  "k.dosed_chem_casrn, k.dosed_chem_name, ",
  
  "c.dose_volume, c.dose_volume_units, c.dose_vehicle, ",
  "c.dose_duration, c.dose_duration_units, ",
  ## dose_frequency dictionary fields
  "j.dose_frequency_original, j.dose_frequency_normalized, ",
  "c.fasting_period, ",
  "c.dose_level_normalized, c.dose_level_original, c.dose_level_units_original, ",
  ## conc_medium dictionary fields
  "i.conc_medium_original, i.conc_medium_normalized, ", 
  ## administration_route dictionary fields
  "h.administration_route_original, h.administration_route_normalized, ",
  ## administration_method dictionary fields
  # "g.administration_method_original, g.administration_method_normalized, ",
  ## administration_form dictionary fields
  # "f.administration_form_original, f.administration_form_normalized, ",
  
  # Subjects table fields
  "b.fk_subject_id, d.weight_kg, d.species, d.sex, d.age, d.age_units, d.age_category, ",
  # Documents table fields
  "c.fk_extraction_document_id, e.pmid, e.year, e.other_study_identifier, ",
  "e.url, e.doi, e.extracted, e.curation_set_tag ",
  
  # Main Table
  "FROM conc_time_values a ",
  
  # Join with series table by series ID
  "LEFT JOIN series b ON a.fk_series_id = b.id ",
  
  # Join to studies table by study ID
  "LEFT JOIN studies c ON b.fk_study_id = c.id ",
  
  # Join to subjects table by subject ID
  "LEFT JOIN subjects d ON b.fk_subject_id = d.id ",
  
  # Join to documents table by extraction document ID
  "LEFT JOIN documents e ON c.fk_extraction_document_id = e.id ",

  # # Join to dictionary tables
  # "LEFT JOIN administration_form_dict f ON c.fk_administration_form_id = f.id ",
  # "LEFT JOIN administration_method_dict g ON c.fk_administration_method_id = g.id ",
  "LEFT JOIN administration_route_dict h ON c.fk_administration_route_id = h.id ",
  "LEFT JOIN conc_medium_dict i ON b.fk_conc_medium_id = i.id ",
  "LEFT JOIN dose_frequency_dict j ON c.fk_dose_frequency_id = j.id ",
  
  # Rename chemical fields for dosed vs. analyzed chemical record foreign keys
  "LEFT JOIN (SELECT id, dsstox_substance_id as dosed_chem_dtxsid, ",
  "chemical_name_original as dosed_chem_name_original, ", 
  "chemical_name_secondary_original as dosed_chem_name_secondary_original, ",
  "dsstox_casrn as dosed_chem_casrn, preferred_name as dosed_chem_name ",
  "FROM chemicals) as k ON c.fk_dosed_chemical_id = k.id ",
  "LEFT JOIN (SELECT id, dsstox_substance_id as analyzed_chem_dtxsid, ",
  "chemical_name_original as analyzed_chem_name_original, ",
  "chemical_name_secondary_original as analyzed_chem_name_secondary_original, ",
  "dsstox_casrn as analyzed_chem_casrn, preferred_name as analyzed_chem_name ",
  "FROM chemicals) as l ON b.fk_analyzed_chemical_id = l.id ",
  
  # Filtering steps
  "WHERE h.administration_route_normalized IN ('iv', 'oral') AND ",
  "(i.conc_medium_normalized IN ('blood', 'plasma') OR ",
  "i.conc_medium_original IN ('blood', 'plasma')) AND ",
  "(j.dose_frequency_normalized IN ('Once') OR e.curation_set_tag IN ('CVT_Showa'))"
)

sql_query <- query_db(query = query, schema = "cvt")

# Need to change the column name for this
names(sql_query)[1] <- "conc_time_id"

# cvtdb_original <- sql_query
# save(cvtdb_original, file = "data/cvtdb_original.rda", compress = "bzip2")
```

```{r harmonizing}
load("data/cvtdb_original.rda")
sql_query <- cvtdb_original
rm(cvtdb_original)

# Harmonize values for easier analysis
cvt_df <- sql_query %>%
  mutate(
    across(ends_with("id"), as.character),
    # Note that sometimes fk_test_chemical_id is NA
    across(all_of(c("time_original",
                    "time_hr",
                    "conc_original",
                    "conc_sd_original",
                    "conc",
                    "conc_sd",
                    "dose_level_original",
                    "dose_level_normalized",
                    "loq")), as.numeric),
    # conc, conc_sd_original, and conc_original
    # have NA/NE/ND values that are coerced to NAs
    year = as.character(year),
    species = tolower(species),
    sex = tolower(sex),
    across(contains("chem_name"), \(x) {
      tolower(force_ascii_quotes(x))
    }),
    dose_volume_units = ifelse(
      dose_volume_units %in% c("NR", "ND"),
      NA_character_,
      gsub(" / ", "/", gsub("ml", "mL", dose_volume_units))
      ),
    dose_volume = signif(as.numeric(dose_volume), digits = 7),
    dose_duration_units = trimws(dose_duration_units),
    dose_duration = as.numeric(stringr::str_extract(dose_duration,
                                pattern = "^\\d+")),
    dose_frequency_normalized = "Once", # Showa is not annotated
    radiolabeled = ifelse(is.na(radiolabeled), FALSE, as.logical(radiolabeled)),
    # for n_subject ranges, take integer value of median 
    # otherwise pull number or NA
    n_subjects_normalized = case_when(
      n_subjects_in_series %in% "NR" ~ NA_real_,
      grepl("-", n_subjects_in_series) ~ floor(mean(
        as.numeric(unlist(strsplit(n_subjects_in_series, split = "-"))),
        na.rm = TRUE
        )),
      .default = as.numeric(
        stringr::str_extract(n_subjects_in_series, pattern = "\\d+")
        )
      )
  )

```

## Some data malformations

There are some duplications in chemical entries such that not all unique chemical ids
represent a unique DTXSID, but rather a unique original name entry.
To fix this, when DTXSIDs for dosed and analyzed chemicals match, I will
be setting `fk_dosed_chemical_id` to `fk_analyzed_chemical_id`.

There is also some radiolabeling experiments that aren't described as such.
We can use `stringr::str_detect(x,"(13|14)c")` to recode `radiolabeled = TRUE`
for these.

Then we should address the fact that the `invivoPKfit_2.0.0` version of the `cvt`
object has 228 chemicals, while the recent query only has 145. This is a
difference of 83.

By hand, I can add back the DTXSIDs for about 15 chemicals. Some of these will
be ChEMBLIDs actually.


```{r malformed_data}
# First quick check to see if any chemical_ids are NA
any(is.na(cvt_df$fk_analyzed_chemical_id))
any(is.na(cvt_df$fk_dosed_chemical_id))
length(unique(cvt_df$analyzed_chem_dtxsid))

cvt_df <- cvt_df %>%
  rowwise() %>%
  mutate(fk_dosed_chemical_id = ifelse(
    identical(analyzed_chem_dtxsid, dosed_chem_dtxsid),
    fk_analyzed_chemical_id,
    fk_dosed_chemical_id
  )) %>%
  ungroup()

cvt_df %>%
  distinct(analyzed_chem_name_original, dosed_chem_name_original, radiolabeled) %>%
  filter(!radiolabeled) %>%
  filter(stringr::str_detect(dosed_chem_name_original, "(13|14)c"))

cvt_df <- cvt_df %>%
  mutate(
    radiolabeled = ifelse(
      stringr::str_detect(dosed_chem_name_original, "(13|14)c"),
      TRUE,
      radiolabeled
    )
  )

quick_stats(cvt_df)
quick_stats(cvt_2.0.0, old_version = TRUE)
# Note unique chemical counts

# Rather than hope most of these chemicals have dtxsids within CvTdb,
# I cross-referenced it with the CompTox database batch search.
# Here I have curated the input by hand
dtxsid_byhand_idless <- data.frame(
  chem_name_original = c(
    "paracetmol", #misspelling
    "antipyrene", #synonym phenazone
    "r-(+)-metoprolol", # using R/S and +/- confused search
    "s-(-)-metoprolol",
    "deacetyl diltiazem", # should be desacetyl
    "valproate (vpa)", # valproic acid
    "valproic acid",
    "clotiapine", # clothiapine
    "padsevonil", # found a ChEMBL_ID...
    "2,2',4,4',5,'5-hexachlorobiphenyl",
    "2,4,5,2',4','5-hexachlorobiphenyl", # number/prime order confused
    "quinidine sulfate",
    "quinidine",
    "quinidine gluconate",
    "furosemide",
    "theophylline",
    "fentanyl",
    "ammonium perfluorooctonoate",
    "perfluorohexanesulfonate anion", # anion confused search
    "3'-azido-3'-deoxythymidine (aids)", # parenthetical confuses search
    "3'-azido-3'-deoxythymidine", # repeat/duplicate of above
    "2,4,5,2'5'-pentachlorobiphenyl", # number/prime order incorrect
    "4,4'-sufonylbisphenol-d8", # deuterium but same as bisphenol S
    "hydroxy-tebuconazole", # CAS 212267-64-6
    "3'-amino-3'-deoxythimidine",
    "bosentan sodium salt",
    "bosentan micronized free sulfonamide",
    "dichloroacetate",
    "fluorotelomer acid 7+3",
    "furosemide",
    "morphine hydrochloride",
    "perfluorohexanesulfonate,potassium salt",
    "potassium perfluorooctane",
    "sodium hexobarbital"
  ),
  comptox_dtxsid = c(
    "DTXSID2020006",
    "DTXSID6021117",
    "DTXSID20230862",
    "DTXSID20230861",
    "DTXSID00881093",
    "DTXSID6023733",
    "DTXSID6023733",
    "DTXSID5022851",
    "CHEMBL4297521",
    "DTXSID2032180",
    "DTXSID2032180",
    "DTXSID101017271",
    "DTXSID4023549",
    "DTXSID80102749",
    "DTXSID6020648",
    "DTXSID5021336",
    "DTXSID9023049",
    "DTXSID8037708",
    "DTXSID80873012",
    "DTXSID8020127",
    "DTXSID8020127",
    "DTXSID8038304",
    "DTXSID3022409",
    "DTXSID50891627",
    "DTXSID00966879",
    "DTXSID7046627",
    "DTXSID7046627",
    "DTXSID2020428",
    "DTXSID90382620",
    "DTXSID6020648",
    "DTXSID9023336",
    "DTXSID3037709",
    "DTXSID0059794",
    "DTXSID9023122"
  )
) %>%
  distinct()

# Fill in the missing DTXSIDs for these
cvt_df <- cvt_df %>%
  # Fill for analyzed chemicals
  left_join(
    dtxsid_byhand_idless %>%
      inner_join(cvt_df %>%
                   distinct(analyzed_chem_name_original, fk_analyzed_chemical_id),
                 by = join_by(chem_name_original == analyzed_chem_name_original)),
    by = join_by(fk_analyzed_chemical_id,
                 analyzed_chem_name_original == chem_name_original)
  ) %>%
  mutate(analyzed_chem_dtxsid = coalesce(analyzed_chem_dtxsid, comptox_dtxsid)) %>%
  select(!comptox_dtxsid) %>%
  # Now do the same for dosed chemical
  left_join(
    dtxsid_byhand_idless %>%
      inner_join(
        cvt_df %>%
          distinct(dosed_chem_name_original, fk_dosed_chemical_id),
        by = join_by(chem_name_original == dosed_chem_name_original)
      ),
    by = join_by(fk_dosed_chemical_id,
                 dosed_chem_name_original == chem_name_original)
  ) %>%
  mutate(dosed_chem_dtxsid = coalesce(dosed_chem_dtxsid, comptox_dtxsid)) %>%
  select(!comptox_dtxsid)

# Now that we've added some missing DTXSIDs, redo the chemical id 
cvt_df <- cvt_df %>%
  rowwise() %>%
  mutate(fk_dosed_chemical_id = ifelse(
    identical(analyzed_chem_dtxsid, dosed_chem_dtxsid),
    fk_analyzed_chemical_id,
    fk_dosed_chemical_id
  )) %>%
  ungroup()

any(is.na(cvt_df$fk_analyzed_chemical_id))
any(is.na(cvt_df$fk_dosed_chemical_id))

quick_stats(cvt_df)


# Now we need to pre-emptively address the chemicals that have different
# dosed_id and analyzed_ids but are actually the same chemical
cvt_df %>%
  filter(fk_analyzed_chemical_id != fk_dosed_chemical_id, 
         analyzed_chem_dtxsid != dosed_chem_dtxsid) %>%
  distinct(analyzed_chem_name_original, dosed_chem_name_original,
           fk_analyzed_chemical_id, fk_dosed_chemical_id,
           analyzed_chem_dtxsid, dosed_chem_dtxsid) %>%
  arrange(analyzed_chem_name_original) %>%
  head()
  # View()

# TO FIX: SALTS
# perfluorooctanesulfonate 692 -> 694, 763 -> 764
# perfluorooctanoate 761 -> 762
# phenobarbital 1147 -> 291
# perfluorobutyrate (two different salts, could be interesting but removing for now)
# perfluorobutanesulfonate 679 -> 680, 777 -> 778
# perfluorohexanesulfonate 671 -> 672, 791 -> 792, 681 -> 682
# tamoxifen 1008 -> 1010
# thiopenal 1148 -> 1150
# imipramine 1158 -> 1159, 1154 -> 1159
# valproate 1163 -> 1164
# nitrite 1013 -> 1014
# odansetron 1117 -> 1118

cvt_df <- cvt_df %>%
  mutate(
    fk_dosed_chemical_id = case_when(
      fk_dosed_chemical_id %in% "692" &
        fk_analyzed_chemical_id %in% "694" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "763" &
        fk_analyzed_chemical_id %in% "764" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "761" &
        fk_analyzed_chemical_id %in% "762" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "1147" &
        fk_analyzed_chemical_id %in% "291" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "679" &
        fk_analyzed_chemical_id %in% "680" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "777" &
        fk_analyzed_chemical_id %in% "778" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "671" &
        fk_analyzed_chemical_id %in% "672" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "791" &
        fk_analyzed_chemical_id %in% "792" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "681" &
        fk_analyzed_chemical_id %in% "682" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "1008" &
        fk_analyzed_chemical_id %in% "1010" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "1148" &
        fk_analyzed_chemical_id %in% "1150" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "1158" &
        fk_analyzed_chemical_id %in% "1159" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "1154" &
        fk_analyzed_chemical_id %in% "1159" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "1163" &
        fk_analyzed_chemical_id %in% "1164" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "1013" &
        fk_analyzed_chemical_id %in% "1014" ~ fk_analyzed_chemical_id,
      fk_dosed_chemical_id %in% "1117" &
        fk_analyzed_chemical_id %in% "1118" ~ fk_analyzed_chemical_id,
      .default = fk_dosed_chemical_id
    )
  ) 


# For figuring out whether there was a change from the original units to reported conc
# And only keep non-radiolabeling experiments, where analyte_dtxsid is known
# and where analyzed chemical is equivalent to the dosed chemical
cvt_df <- cvt_df %>% mutate(conc_unit_norm_factor = signif(conc/conc_original, 1),
                            .after = conc_units_normalized) 

cat("Current # chemicals: ", length(unique(cvt_df$analyzed_chem_dtxsid)), "\n")
cat("Number of chemicals where analyzed_chem_dtxsid is NA: ",
    sum(is.na(unique(cvt_df[c("fk_analyzed_chemical_id",
                               "analyzed_chem_dtxsid")])$analyzed_chem_dtxsid)),
    "\n")


cat("Number of radiolabelling experiments: ",
    sum(distinct(cvt_df, analyzed_chem_dtxsid, radiolabeled) %>%
          pull(radiolabeled) %>%
          {. %in% TRUE}
        )
    )
distinct(cvt_df, analyzed_chem_dtxsid,
         analyzed_chem_name_original, radiolabeled) %>%
  filter(radiolabeled %in% TRUE, !is.na(analyzed_chem_dtxsid))



cat("Number of chemicals with non-matching ids ",
    cvt_df %>%
      filter(!is.na(analyzed_chem_dtxsid),
             !(radiolabeled %in% TRUE),
             fk_analyzed_chemical_id != fk_dosed_chemical_id) %>%
      distinct(analyzed_chem_dtxsid) %>%
      NROW()
)


quick_stats(cvt_df)
# This should be the base CvTdb prior to filtering steps

```


# Validating data

This step in the loading process allows us to correct some mis-annotations in the
data, without directly changing CvTdb (the review process there is more rigorous).
Some of these changes will be sent as a ticket item for the CvTdb team.
Other times, the annotation is correct, it's just that units need to be standardized
for `invivoPKfit` specifically.  

There are some procedures needed to be taken to standardized some of this data
such that dose units are all in mg/kg of bodyweight and concentration units are in
ug/L.

## Preliminary Filtering

I begin with a couple of filtering steps:  

+ Exclude data without any concentration value  
+ Exclude data with only one observation per *study_id*

```{r preliminary_filtering}

cvt_df <- cvt_df %>%
  filter(!(radiolabeled %in% TRUE),
         !is.na(analyzed_chem_dtxsid),
         (fk_analyzed_chemical_id == fk_dosed_chemical_id)) %>%
  distinct()

quick_message(text = c("Filtering out:",
                       "Missing {.code analyzed_chem_dtxsid}",
                       "Radiolabeling experiments",
                       "Data where the analyzed chemicals and dosed chemicals are different"))


quick_stats(cvt_df)


# Filtering out non-circulation mediums (these are retained in cvtdb_original)
cvt_df <- cvt_df %>%
  filter(conc_medium_normalized %in% c("blood", "plasma")) 

quick_message(text = c("Filtering out:",
                       "Non-plasma/blood medium collected."))

# Filter out where all values in experiment are missing values/below LOQ
# Also filter out observations where 
cvt_df <- cvt_df %>%
  mutate(
    conc = ifelse(conc < 0, NA_real_, conc),
    conc_original = ifelse(conc_original < 0, NA_real_, conc_original)
  ) %>%
  group_by(analyzed_chem_dtxsid, species, fk_extraction_document_id,
           administration_route_normalized, conc_medium_normalized) %>%
  filter(
    !(if_all(conc, is.na) & if_all(conc_original, is.na))
  ) %>%
  ungroup() %>%
  distinct()


quick_message(text = c("Filtering out:",
                       "Experiments missing concentration values altogether."))

quick_stats(cvt_df)

# Dose Units: Need mg/kg... = ug/mg = ng/ug, and kg = L
# Conc Units: Need mg/L... = ug/mL = ng/uL = pg/nL, and kg = L, g = mL
cvt_df <- cvt_df %>% mutate(
  conc_units_normalized = stringr::str_replace(
    conc_units_original, "(?<=/m?)l", "L"
  ),
  loq_units = stringr::str_replace(loq_units, "(?<=/m?)l", "L"),
  invivPK_dose_level_units = "mg/kg",
  invivPK_conc_units = "ug/mL"
  )
# Set the equivalent units
equiv_mgkg <- c("mg/kg", "ug/g", "ng/mg")
equiv_mgL <- c("mg/L", "ug/mL", "ng/uL", "mg/kg", "mg/g", "ug/mg")


quick_stats(cvt_df)

# Filtering out entries with only single observations per study_id
cvt_df <- cvt_df %>%
  group_by(fk_study_id) %>%
  filter(n() > 1) %>%
  ungroup()

quick_stats(cvt_df)

```


## Specific Data Changes

To summarize these changes:  

+  Convert original dose units for CEBS study _S0916_ to mg/kg.  
+  Convert original dose units for CEBS study _S0624_ to mg/kg. Data got corrected in CEBS, trusting that.  
+  Input the LOQ for studies _S0976_.  
+  Infer the LOQ for study _S0328_ as 1, given the values near it deemed above and below LOQ.   



```{r specific_data_validation}
# Looking for suspect dose levels
quick_message(paste0("Looking at dose units not equivalent to mg/kg where ",
                     "dose_level_original and dose_level_normalized ",
                     "{.emph remain the same}"))

cvt_df %>% filter(!(dose_level_units_original %in% equiv_mgkg),
                  dose_level_normalized == dose_level_original) %>%
  distinct(fk_study_id, 
           dose_level_original, dose_level_normalized,
           dose_level_units_original,
           administration_route_normalized,
           pmid, fk_extraction_document_id,
           other_study_identifier) %>%
  glimpse()

# Set units
# Fix some dosing units which are not weight normalized
cvt_df <- cvt_df %>%
  mutate(invivPK_dose_level = dose_level_normalized,
         invivPK_loq = loq,
         invivPK_loq_units = loq_units,
         invivPK_conc_sd = conc_sd,
         invivPK_conc = conc)

# Now only a few studies need "extra" normalizing
quick_message(c(
  "Data Modification: Changing `conc` for following chemicals",
  "hexobarbital, phenobarbital, thiopental"
))
quick_message(c(
  "Data Modification: Changing `conc_units_normalized` for following chemicals",
  "hexobarbital, phenobarbital, thiopental, TAME, chlorpyrifos, benzo(a)pyrene",
  "phenacetin, perfluorononanoic acid, perfluorodecanoic acid, perfluorooctanoic acid"
))
quick_message(c(
  "Data Modification: Changing `invivPK_loq` for following chemicals",
  "TAME"
))
quick_message(c(
  "Data Modification: Changing `invivPK_loq_units` for following chemicals",
  "TAME",
  "Any NA value for invivPK_loq_units to 'ug/mL'",
  "Any 'ng' value to 'ng/mL'"
))

cvt_df <- cvt_df %>%
  mutate(
    invivPK_conc = case_when(
      # TAME OK
      # chlorpyrifos OK
      # benzo(a)pyrene OK
      # hexobarbital
      conc_units_normalized %in% "x 10^-3 M" &
        analyzed_chem_dtxsid %in% "DTXSID9023122" ~ conc_original * 0.23611,
      # phenobarbital
      conc_units_normalized %in% "x 10^-3 M" &
        analyzed_chem_dtxsid %in% "DTXSID5021122" ~ conc_original * 0.23208,
      # thiopental
      conc_units_normalized %in% "x 10^-3 M" &
        analyzed_chem_dtxsid %in% "DTXSID1023653" ~ conc_original * 0.24211,
      .default = invivPK_conc
    ),
    conc_units_normalized = case_match(
      analyzed_chem_dtxsid,
      c("DTXSID9023122",
        "DTXSID5021122",
        "DTXSID1023653",
        "DTXSID8024521",
        "DTXSID4020458",
        "DTXSID2020139",
        "DTXSID1021116",
        "DTXSID8031865",
        "DTXSID3031860",
        "DTXSID8031863"
        ) ~ "ug/mL",
      .default = conc_units_normalized
    ),
    invivPK_loq = case_when(
      # TAME
      invivPK_loq_units %in% "nmol/mL" &
        analyzed_chem_dtxsid %in% "DTXSID8024521" ~ loq * 0.102,
      .default = invivPK_loq
    ),
    invivPK_loq_units = case_when(
      invivPK_loq_units %in% "nmol/mL" &
        analyzed_chem_dtxsid %in% "DTXSID8024521" ~ "ug/mL",
      is.na(invivPK_loq_units) ~ "ug/mL",
      other_study_identifier %in% "K02922" ~ "ng/mL", # incorrect extraction
      invivPK_loq_units %in% "ng" ~ "ng/mL",
      .default = invivPK_loq_units
    ),
    weight_kg = case_when(
      fk_subject_id %in% "41249" ~ 76, # extraction typo
      .default = weight_kg
    )
  )

# Fixing DOSE units
unique(cvt_df$dose_level_units_original)

cvt_df %>% 
  filter(!(dose_level_units_original %in% equiv_mgkg),
                  dose_level_normalized == dose_level_original) %>%
  distinct(fk_study_id, 
           dose_level_original, dose_level_normalized,
           dose_level_units_original,
           administration_route_normalized, fk_extraction_document_id)

# Adjust invivPK_dose_level for non-standard units
cvt_df %>% filter(is.na(invivPK_dose_level)) %>% count(dose_level_units_original)

cvt_df <- cvt_df %>% 
  mutate(
    invivPK_dose_level = case_when(
      # Standard weight of human (75kg)
      is.na(invivPK_dose_level) &
        is.na(weight_kg) &
        species %in% "human" &
        dose_level_units_original %in% "mg" ~ dose_level_original / 75,
      dose_level_units_original %in% "mg" ~ signif(
        invivPK_dose_level / weight_kg, digits = 5
      ),
      dose_level_units_original %in% "g" ~ signif(
        1E3 * invivPK_dose_level / weight_kg, digits = 5
      ),
      dose_level_units_original %in% "ug" ~ signif(
        1E-3 * invivPK_dose_level / weight_kg, digits = 5
      ),
      is.na(invivPK_dose_level) &
        dose_level_units_original %in% "ug/kg" ~ dose_level_original * 1E-3,
      is.na(invivPK_dose_level) &
        dose_level_units_original %in% "ng/kg" ~ dose_level_original * 1E-6,
      is.na(invivPK_dose_level) &
        dose_level_units_original %in% c("mg/kg", "ug/mL") ~ dose_level_original,
      .default = invivPK_dose_level
    )
  )

cvt_df %>% filter(is.na(invivPK_dose_level)) %>% count(dose_level_units_original)
cvt_df %>% filter(is.na(invivPK_dose_level)) %>% glimpse()

quick_stats(cvt_df)
```

## Routine Unit Conversions and final filtering steps

Here I converted units for concentration, concentration standard deviation,
and LOQ to *ug/mL* and dose units to *mg/kg*. There is a special case for records
in series 23340 and 23380 where the `conc_original` value is already in *mg/kg*
but is somehow rounded in `conc`, which gives zero values for the final timepoints in this series
even when these are not below LOQ.  

 There are some final filtering steps as well:  

+  Filter out chemicals dosed multiple times throughout the experiment.  
+  Filter out chemicals with very limited information.  


```{r general_unit_conversions}
apply(cvt_df, 2, \(x) {
  sum(is.na(x))
})


# quick_stats(cvt_df)
quick_message("Unique LOQ units:")
print(table(cvt_df$invivPK_loq_units))


quick_message(c(
  "Modifying Data:",
  "Converting loq units to concentration unit standard mg/L",
  "Converting concentration units to standard mg/L",
  "Converting concentration sd units to the standard mg/L"
))
# Normalize LOQ units
cvt_df <- cvt_df %>%
  mutate(invivPK_loq = case_match(
    invivPK_loq_units,
    c("ug/L", "ng/mL", "ng/g") ~ invivPK_loq * 1E-3,
    c("pg/mL") ~ invivPK_loq * 1E-6,
    .default = invivPK_loq
    )) %>% 
  mutate(invivPK_loq_units = "ug/mL") # mg/L and ug/mL are same scale

# Normalize conc_sd and conc units manually
quick_message("Unique conc units:")
print(table(cvt_df$conc_units_normalized))

# Some concentrations are already normalized
cvt_df <- cvt_df %>%
  filter(!(conc_units_normalized %in% "molar percentage")) %>%
  mutate(invivPK_conc_sd = case_when(
    conc_units_normalized %in% c("ng/mL", "ng/g", "ug/L") ~ conc_sd_original*1E-3,
    conc_units_normalized %in% c("g/dL") ~ conc_sd_original*1E-4,
    conc_units_normalized %in% c("pg/mL") ~ conc_sd_original*1E-6,
    conc_units_normalized %in% "percent of dose" ~ conc_sd_original * 
      invivPK_dose_level/100,
    .default = invivPK_conc_sd
  ))
# Need to normalize the ng-eq/mL sample, conc is generally already normalized
# 
cvt_df <- cvt_df %>%
  mutate(invivPK_conc = case_when(
    conc_units_normalized %in% c("ng/mL", "ng/g", "ug/L") ~ conc_original*1E-3,
    conc_units_normalized %in% c("g/dL") ~ conc_original*1E-4,
    conc_units_normalized %in% c("pg/mL") ~ conc_original*1E-6,
    conc_units_normalized %in% "percent of dose" ~ conc_original * invivPK_dose_level/100,
    is.na(invivPK_conc) ~ conc_original,
    .default = invivPK_conc
  ))

quick_message("Are there chemicals with very few (less than 5) observations still?")
cvt_df %>% count(analyzed_chem_dtxsid) %>% arrange(n) %>% head()
# No


# More notes:
# DTXSID6020438 & DTXSID0020868 rat is from water (top) and oil (bottom curve) gavage


cvt_df <- cvt_df %>%
  mutate(time_hr = case_when(
    is.na(time_hr) &
      !is.na(time_original) & 
      time_units_original %in% c("hours", "hour") ~ time_original,
    .default = time_hr
  ))

# Filter out negative timepoints
# Set subjects to 1 if conc_sd is NA
cvt_df <- cvt_df %>%
  filter(time_hr >= 0) %>%
  mutate(
    n_subjects_normalized = case_when(
      is.na(invivPK_conc_sd) ~ 1,
      is.na(n_subjects_normalized) ~ 1,
      .default = n_subjects_normalized
    )
  ) 

quick_message(c(
  "Modifying dataset:",
  "Set missing time_hr to time_original if these are in hour(s).",
  "Filter out negative timepoints.",
  "Set n_subjects_normalized to 1 if conc_sd or n_subjects_normalized is missing."
))



glimpse(cvt_df)
apply(cvt_df, 2, \(x) {
  sum(is.na(x))
})

quick_stats(cvt_df)

```

Note the columns prefixed by _invivPK_. These are generated as a non-destructive form
of modifying the data that we will use for _invivoPKfit_. The only column from the
SQL query result of CvTdb that is actually changed is the `analyzed_chem_dtxsid` as 
described earlier.

```{r plot_by_dtxsid}

cvt_df %>%
  ggplot(aes(x = time_hr, y = invivPK_conc, group = analyzed_chem_dtxsid,
             color = analyzed_chem_dtxsid)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  theme_bw() +
  scale_y_log10() +
  theme(legend.position = "none")
```


```{r final_checks}

cvt_df %>%
  count(is.na(dose_level_normalized), 
        is.na(invivPK_dose_level),
        is.na(dose_level_original)) %>% glimpse()

cvt_df %>%
  count(is.na(invivPK_conc_sd) & n_subjects_normalized > 1)

cvt_df %>%
  count(is.na(n_subjects_normalized))

```



Save the pulled CVT data with the edits/normalizations, and also save the current date.

```{r saving_data, include=FALSE, eval=FALSE}
cvt_date <- Sys.Date()

cat(diff_log_cvt(cvt_df, 
                 notes = c(
                   ""
                 )
),
file = "data-raw/cvt_changelog.txt",
append = TRUE
)

cvt <- cvt_df
save(cvt, file = "data/cvt.rda", compress = "bzip2")
save(cvt_date, file = "data/cvt_date.rda")

```

# QSAR Bakeoff Run

```{r running}
my_pk <- pk(cvt,
            mapping = ggplot2::aes(
              Chemical = analyzed_chem_dtxsid,
              Chemical_Name = analyzed_chem_name_original,
              DTXSID = analyzed_chem_dtxsid,
              CASRN = analyzed_chem_casrn,
              Species = species,
              Reference = fk_extraction_document_id,
              Media = conc_medium_normalized,
              Route = administration_route_normalized,
              Dose = invivPK_dose_level,
              Dose.Units = "mg/kg",
              Subject_ID = fk_subject_id,
              Series_ID = fk_series_id,
              Study_ID = fk_study_id,
              ConcTime_ID = conc_time_id,
              N_Subjects = n_subjects_normalized,
              Weight = weight_kg,
              Weight.Units = "kg",
              Time = time_hr,
              Time.Units = "hours",
              Value = invivPK_conc,
              Value.Units = "mg/L",
              Value_SD = invivPK_conc_sd,
              LOQ = invivPK_loq
            ))

my_pk <- my_pk +
  stat_error_model(error_group = vars(Chemical, Species)) +
  settings_optimx(method = "bobyqa") +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE,
                      suppress.messages = TRUE) +
  scale_conc(dose_norm = TRUE, log10_trans = TRUE)

my_pk <- do_preprocess(my_pk)
apply(my_pk$data, 2, \(x) { any(is.na(x)) })

my_pk <- do_data_info(my_pk)
my_pk <- do_prefit(my_pk)

my_pk <- do_fit(my_pk, n_cores = 12)


fit_pl <- plot(my_pk, best_fit = TRUE, log10_C = FALSE, use_scale_conc = TRUE)

fit_pl %>% filter(Chemical %in% "DTXSID1021116", Species %in% "human") %>%
  pull(final_plot) %>% .[[1]]
fit_pl %>% filter(Chemical %in% "DTXSID9025617", Species %in% "mouse") %>%
  pull(final_plot) %>% .[[1]]
fit_pl %>% filter(Chemical %in% "DTXSID9025617", Species %in% "rat") %>%
  pull(final_plot) %>% .[[1]]
fit_pl %>% filter(Chemical %in% "DTXSID2021781", Species %in% "mouse") %>%
  pull(final_plot) %>% .[[1]]

save(my_pk, file = "data-raw/temp_pk.rda")

```






