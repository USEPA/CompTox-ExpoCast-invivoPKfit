---
title: "PK object batch mode trial"
author: "Gilberto Padilla Mercado"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
set.seed(2023)
library(tidyverse, quietly = TRUE)
devtools::load_all() # Loads the invivopkfit package in feature/pkS3obj_facet branch
tidyverse_conflicts()
```

## Working with one DTXSID + Species combination

The first step is understanding how to work with a single DTXSID + Species combination.
Once we know how to do this, it will be easier to apply it to (potentially)
a list of these objects in a vectorized fashion.
Here I subset the `cvt` object and use that as my working data.

```{r data_loading}
# There are 103 unique chemicals in this object
cvt %>% pull(chemicals_analyzed.dsstox_substance_id) %>%
  unique() %>%
  length()

# easy fit
my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% "DTXSID5020732")



my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% c("DTXSID0020442"),
                subjects.species_harmonized %in% "hamster",
                studies.administration_route_normalized %in% "iv")
my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% "DTXSID3032179")

my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% "DTXSID9030258")



my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% c("DTXSID7030066",
                                                              "DTXSID0020442",
                                                              "DTXSID2021315"),
                subjects.species_harmonized %in% "rat")


my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% c("DTXSID2039336",
                                                              "DTXSID7029904",
                                                              "DTXSID1021087",
                                                              "DTXSID2020682"))

```

Next, I want to follow the steps required for the particular analysis I would like.
In this instance, I set the optimizer to "L-BFGS-B" and dose-normalize the output.
I do not scale the time or log-transform the concentration values.
Since I would like to do a "Pooled" analysis,
I set the `error_group = vars(Chemical, Species)`.

```{r single_fit}
# Pooled
my_pk <- pk(data = my_predata) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species)) 
# Add Reference for Joint Analysis

my_pk <- do_preprocess(my_pk)
plot(my_pk, print_out = TRUE)

my_pk <- do_data_info(my_pk)

my_pk <- do_prefit(my_pk)


my_pk <- do_fit(my_pk)

plot(my_pk,
     method = "L-BFGS-B",
     print_out = TRUE)
# Joint
my_pk <- pk(data = cvt) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species, Reference)) 
# Add Reference for Joint Analysis

my_pk <- do_preprocess(my_pk)

my_pk <- do_data_info(my_pk) 
# summarizes error (Returning more or less than 1 row per summarize)

my_pk <- do_prefit(my_pk)


my_pk <- do_fit(my_pk)
```

Batch mode works! Now, I have updated the `coef`, `predict`, `rmse`, and `residuals`
methods.

```{r after_method_update}
# Changed pk_methods coef() and predict() to those above
# Ran the following after making the pk object:
devtools::load_all()
all_my_data <- my_pk$data # following the full dataset to prefit
my_pk$data %>% filter(Chemical == "DTXSID2021103")

my_coefs_update <- coef(my_pk, drop_sigma = TRUE)
my_pred_update <- predict(my_pk,
                          exclude = TRUE, # add the "exclude" column to output
                          use_scale_conc = TRUE)

predict(my_pk,
        exclude = TRUE, # add the "exclude" column to output
        use_scale_conc = TRUE)


my_pred2 <- predict(my_pk,
                    newdata = data.frame(Chemical = "DTXSID2021731",
                                         Species = "rat",
                                         Route = "iv",
                                         Media = "plasma",
                                         Dose = 20,
                                         Time = 1.6,
                                         Time.Units = "hours"),
                    exclude = FALSE,
                    use_scale_conc = FALSE)

rmse(my_pk) %>% View("RMSE_test")
residuals(my_pk) %>% View("Residuals_test")

```


```{r plotting_method}


plot(my_pk, use_scale_conc = TRUE,
     print_out = TRUE, log10_C = FALSE)

my_plot <- plot(my_pk, use_scale_conc = TRUE)

# This is printable into a one file, multipage pdf
pdf(file = paste0(Sys.getenv("FIG_DIR"), "plotMethod_freeY.pdf"),
    width = 10,
    height = 8)
plot(my_pk, use_scale_conc = TRUE,
     print_out = TRUE)
dev.off()



```

```{r get_tkstats_logLik_methods}
my_tkstats <- get_tkstats(my_pk)

names(my_tkstats)
my_tkstats


my_logLike_update <- logLik(my_pk)




```


```{r remaining_methods}
devtools::load_all()
AIC(my_pk2) %>% View()
BIC(my_pk)

get_winning_model(my_pk)
eval_tkstats(my_pk)


my_predata <- cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% "DTXSID0020442")
my_pk <- pk(data = my_predata) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species)) 
my_pk <- do_fit(my_pk)

my_hess <- coef_sd(my_pk, table_format = TRUE)

ggplot(inner_join(get_winning_model(my_pk), my_hess),
       aes(x = Fgutabs,
           y = V1)) +
  geom_point() +
  facet_grid(cols = vars(model))

```

The purpose of the following code is to generate data.frames with information for
all 103 chemicals in the `cvt` dataset that comes with `invivopkfit`.
I will need to do append each dataframe to the last for the outputs of the following
methods:

- `AIC()`
- `BIC()` left-joined with `AIC` output
- `get_tkstats()`

I will also have to fit these iteratively and manage the memory as part of the loop.


```{r allDTXSIDs_analysis}

# after fitting pk object for all cvt objects
# saveRDS(my_pk, file = "data-raw/all_cvt_pk.rds")
# saveRDS(my_pk, file = "data-raw/all_cvt_pk_JOINT.rds")
my_pk <- readRDS("data-raw/all_cvt_pk.rds")
my_coefs <- coef(my_pk, drop_sigma = FALSE)
get_winning_model(my_pk) %>%
  filter(model %in% c("model_2comp"),
         method == "L-BFGS-B") %>%
  dplyr::select(Chemical, Species) %>% distinct() %>% nrow()
all_my_data  %>% dplyr::select(Chemical, Species) %>% distinct() %>% nrow()
my_AIC <- AIC(my_pk)
my_tkstats <- get_tkstats(my_pk)
my_IC <- left_join(AIC(my_pk), BIC(my_pk))

my_IC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "bobyqa") %>%
  ungroup() %>%
  count(model)
# model_1comp 59
# model_2comp 50
# model_flat   2

my_IC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "L-BFGS-B") %>%
  ungroup() %>%
  # filter(model == "model_flat") %>% pull(Chemical) %>% unique()
  count(model)
# model_1comp 57
# model_2comp 50
# model_flat   4



my_preds <- predict(my_pk,
                    use_scale_conc = TRUE)

winmodels <- my_IC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "L-BFGS-B") %>%
  ungroup() %>%
  dplyr::select(Chemical, Species,
                method, model)

my_preds <- inner_join(winmodels, my_preds)
my_tkstats <- inner_join(winmodels, my_tkstats) %>%
  dplyr::select(-TKstats) %>% distinct()
my_nca <- get_nca(my_pk,
                  nca_group = vars(Chemical, Species,))
my_nca <- my_nca %>% dplyr::select(-param_sd_z, -param_units) %>%
  pivot_wider(names_from = param_name,
              values_from = param_value)


all_my_data <- my_pk$data
all_my_data %>%
  filter(Detect %in% TRUE,
         exclude %in% FALSE,
         Dose > 0) %>%
  group_by(Chemical,
           Species,
           Reference,
           Route, 
           Media,
           Dose, Time) %>%
  filter(n() > 1,
         sum(is.na(Conc)) != n(),
         LOQ < Conc) %>%
  mutate(meanConc = mean(Conc, na.rm = TRUE)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(foldConc = Conc / meanConc) %>%
  filter(Route == "iv") %>%
  count(foldConc >= 0.5 & foldConc <= 2) %>%
  {.[[2,2]]/(.[[1,2]] + .[[2,2]])}
# 88.9% inside twofold
# 2.2%  above twofold 
# 8.8%  below twofold
# 
# 

all_my_data %>%
  filter(Detect %in% TRUE,
         exclude %in% FALSE,
         Dose > 0) %>%
  group_by(Chemical,
           Species,
           Reference,
           Route, 
           Media,
           Dose, Time) %>%
  filter(n() > 1,
         sum(is.na(Conc)) != n(),
         LOQ < Conc) %>%
  mutate(meanConc = mean(Conc, na.rm = TRUE)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(foldConc = Conc / meanConc) %>%
  ggplot(aes(x = foldConc)) +
  geom_histogram(binwidth = 0.1,
                 fill = "grey5") +
  coord_cartesian(xlim =  c(0, 4),
                  ylim = c(0, 2000)) +
  scale_y_continuous(expand = c(0, 0)) +
  expand_limits(y = 0) +
  geom_vline(xintercept = c(0.5, 2), color = "red3", linetype = "dashed") +
  # annotate(geom= "text",
  #          x = 1.25, y = 1800,
  #          label = "88.9% of Observations\n within a factor of 2") +
  theme_classic() +
  labs(x = "Concentration Normalized to Average",
                y = "Number of Observations") +
  theme(panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.4))

ggsave(paste0(Sys.getenv("FIG_DIR"),
              "NormalizedConcentrations_2023-07-11.png"),
       height = 3.5,
       width = 5.5,
       units = "in")


all_my_data %>%
  group_by(Chemical,
           Species,
           Reference,
           Route,
           Dose, Time) %>%
  filter(n() > 1,
         sum(is.na(Conc_trans)) != n(),
         exclude == FALSE) %>%
  mutate(meanConc = mean(Conc_trans, na.rm = TRUE)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(foldConc = Conc_trans / meanConc) %>%
  inner_join(my_tkstats %>%
              dplyr::select(Chemical, Species,
                            Route, Media,
                            tmax) %>%
              filter(!is.na(tmax))) %>%
  group_by(Chemical,
           Species,
           Reference,
           Route,
           Media,
           Dose) %>%
  mutate(
         normTime = ifelse(
           Route == "iv",
           1 + Time/max(Time),
           ifelse(
             Time > tmax,
             ((Time - tmax)/max(Time)) + 1,
             0.5 + Time/(2*tmax)
           )
         )) %>%
  ggplot(aes(
    x = normTime,
    y = foldConc
  )) +
  geom_point(alpha = 0.2,
             aes(color = Chemical)) +
  geom_vline(xintercept = 1, color = "blue", linetype = "dashed") +
  geom_vline(xintercept = 2, color = "green4", linetype = "dashed") +
  geom_hline(yintercept = c(0.5, 2), color = "red3", linetype = "dashed") +
  facet_grid(cols = vars(Route),
             rows = vars(Species),
             scales = "free_x") +
  labs(x = "ADME-Normalized Time",
       y = "Mean-Normalized Concentration") +
  theme(aspect.ratio = 1,
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text.x = element_blank())

ggsave(paste0(Sys.getenv("FIG_DIR"),
              "ADME_NormalizedTime-NormalizedConcentrations_onlyDetects_2023-07-19.png"),
       height = 4,
       width = 6,
       units = "in")


# Per chemical + Species average mean normalized concentration variability over time
all_my_data %>%
  group_by(Chemical,
           Species,
           Reference,
           Route,
           Dose, Time) %>%
  filter(n() > 1,
         sum(is.na(Conc)) != n(),
         LOQ < Conc,
         exclude == FALSE) %>%
  mutate(meanConc = mean(Conc, na.rm = TRUE)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(foldConc = Conc / meanConc) %>%
  inner_join(my_tkstats %>%
              dplyr::select(Chemical, Species,
                            Route, Media,
                            tmax) %>%
              filter(!is.na(tmax))) %>%
  group_by(Chemical, Species, Route, Media, Dose) %>%
  summarize(sdFC = sd(foldConc)) %>%
  mutate(maxDose = max(Dose),
         minDose = min(Dose)) %>%
  ungroup() %>%
  add_count(Dose, name = "Unique_Doses") %>%
  filter(Unique_Doses == 1) %>%
  arrange(desc(sdFC))

my_tkstats %>%
              dplyr::select(Chemical, Species,
                            Route, Media, model, method,
                            tmax) %>%
              filter(!is.na(tmax))

all_my_data %>%
              dplyr::select(Chemical, Species,
                            Route, Media, Dose,
                            Reference) %>%
  distinct() %>% nrow()

my_preds <- predict(my_pk,
                    use_scale_conc = TRUE)

winmodels <- AIC(my_pk) %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "L-BFGS-B") %>%
  ungroup() %>%
  dplyr::select(Chemical, Species,
                method, model)

my_preds <- inner_join(winmodels, my_preds)
my_tkstats <- inner_join(winmodels, my_tkstats) %>%
  dplyr::select(-TKstats) %>% distinct()
my_nca <- get_nca(my_pk,
                  nca_group = vars(Chemical, Species,))
my_nca <- my_nca %>% dplyr::select(-param_sd_z, -param_units) %>%
  pivot_wider(names_from = param_name,
              values_from = param_value)



my_preds %>%
  group_by(Chemical,
           Species,
           Route, Media,
           Dose, Time) %>%
  filter(n() > 1,
         sum(is.na(Conc_trans)) != n(),
         model %in% c("model_flat"),
         exclude %in% FALSE,
         Detect %in% TRUE) %>%
  mutate(meanConc = mean(Conc_trans, na.rm = TRUE)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(foldConc = Conc_trans / meanConc,
         foldPred = Conc_est / Conc_trans) %>% 
  # For percentages
  ungroup() %>%
  count(!(foldPred >= 0.5 & foldPred <= 2) &
          !(foldConc >= 0.5 & foldConc <= 2)) %>%
  {.[[2,2]]/(.[[1,2]] + .[[2,2]])}
  # For Plotting
  ggplot(aes(
    y = foldPred,
    x = foldConc
  )) +
  geom_bin2d(bins = 40, color = NA) +
  geom_hline(yintercept = c(0.5, 2), linetype = "dashed") +
  geom_vline(xintercept = c(0.5, 2), linetype = "dashed") +
  facet_grid(cols = vars(model)) +
  scale_x_log10(limits = c(0.0001, 50)) +
  scale_y_log10(limits = c(0.001, 1000)) +
  scale_fill_viridis_c(option = "cividis",
                       limits = c(1, 100),
                       oob = oob_squish) +
  labs(y = "Model Performance",
       x = "Data Variability") +
  theme(aspect.ratio = 1,
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        axis.ticks = element_blank(),
        axis.line = element_blank())

ggsave(paste0(Sys.getenv("FIG_DIR"),
              "ModelPerformance_vDataVariability_2023-07-20.png"),
       height = 3.5,
       width = 7,
       units = "in")  
  
  
# Why are 38-39% of adequate data have models that are too variable?
# 
my_preds %>%
  group_by(Chemical,
           Species,
           Route,
           Dose, Time) %>%
  filter(n() > 1,
         sum(is.na(Conc_trans)) != n(),
         exclude == FALSE,
         Detect == TRUE) %>%
  mutate(meanConc = mean(Conc_trans, na.rm = TRUE)) %>%
  ungroup() %>%
  rowwise() %>%
  mutate(foldConc = Conc_trans / meanConc,
         foldPred = Conc_est / Conc_trans) %>% 
  # filter(model == "model_2comp") %>%
  mutate(VAR_DATA = ifelse(
    (foldPred > 2 | foldPred < 0.5) & (foldConc <= 2 & foldConc >= 0.5),
    TRUE, FALSE
  )) %>%
  group_by(Chemical, Species) %>%
  mutate(VAR_TRUE = sum(VAR_DATA %in% TRUE),
         VAR_FALSE = sum(VAR_DATA %in% FALSE)) %>%
  dplyr::select(-VAR_DATA) %>% distinct() %>%
  mutate(PERCENT_TRUE = VAR_TRUE/(VAR_TRUE + VAR_FALSE),
         MAJOR_TRUE = ifelse(PERCENT_TRUE > 0.6, TRUE, FALSE)) %>%
  # View("Count")
  ggplot(aes(
    x = Time,
    y = Conc_est,
    color = paste(Chemical, Species),
    group = paste(Chemical, Species)
  )) +
  geom_point() +
  geom_line() +
  facet_grid(cols = vars(MAJOR_TRUE),
             rows = vars(model)) +
  labs(y = "Predicted Concentrations",
       x = "Time") +
  # xlim(0, 2000) +
  theme(aspect.ratio = 1,
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        legend.position = "none",
        axis.ticks = element_blank(),
        axis.line = element_blank())
  
  



# Saving some CSVs
# my_tkstats %>% write_csv(file = "data-raw/Pooled_TKstats.csv")
# my_nca %>% write_csv(file = "data-raw/NonCompartmentalAnalysis.csv")
# Loading CSVs
my_nca <- read_csv(file = "data-raw/NonCompartmentalAnalysis.csv")

my_preds %>%
  rowwise() %>%
  mutate(Pred_Obs = Conc_trans/Conc_est) %>%
  filter(is.finite(Pred_Obs),
         model %in% c("model_1comp", "model_2comp")) %>%
  # mutate(pass = ifelse(Pred_Obs < 0.5, TRUE, FALSE)) %>%
  # pull(pass) %>% table()
  ggplot(aes(x = Pred_Obs)) +
  geom_histogram(binwidth = 0.4,
                 fill = "grey5") +
  scale_x_log10(limits = c(NA, 1E6)) +
  expand_limits(y = 0) +
  geom_vline(xintercept = c(0.5, 2), color = "red3", linetype = "dashed") +
  facet_grid(cols = vars(model),
             rows = vars(Route)) +
  labs(x = "Predicted/Observed",
       y = "Number of Observations") +
  theme_classic() +
  theme(aspect.ratio = 1,
        panel.border = element_rect(color = "black", fill = NA),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.4))

# 91.1% of Pred_Obs are finite
# 16.6% Are below two-fold
# 33.2%  Are above two-fold
# 50.2% Are within twofold

ggsave(paste0(Sys.getenv("FIG_DIR"),
              "PredictedObserved_compartmentModels_2023-07-11.png"),
       height = 6, width = 7)


# Pooled analysis
all_my_data %>% group_by(Chemical, Species, Reference, Media, Route) %>%
  filter(is.finite(Conc)) %>%
  summarise(OOM = log10(max(Conc) / min(Conc))) %>% 
  ggplot(aes(x = OOM)) +
  geom_histogram(bins = 15,
                 color = NA,
                 fill = "grey5") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  scale_x_continuous(breaks = c(0, 1, 2, 3, 4, 5)) +
  labs(x = "Orders of Magnitude per Series\n log10(max/min)",
       y = "Count") +
  theme(aspect.ratio = 1,
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        axis.ticks = element_blank(),
        axis.line = element_blank())

ggsave(paste0(Sys.getenv("FIG_DIR"),
              "OrdersOfMagnitude_2023-07-12.png"),
       height = 4, width = 4)

my_pk$prefit$fit_check %>% filter(fit_decision == "abort") %>%
  dplyr::select(model, Chemical) %>% distinct()

all_my_data %>%
  filter(Chemical == "DTXSID2021781")


my_coefs %>% inner_join(get_winning_model(my_pk)) -> my_coefs
my_coefs %>% inner_join(get_data_summary(my_pk)) -> my_coefs


my_coefs %>%
  mutate(model = 
           case_when(
             model == "model_1comp" ~ "1-compartment",
             model == "model_2comp" ~ "2-compartment",
             model == "model_flat"  ~ "Null"
           )) %>%
  ggplot(aes(x = sigma_value/n_obs)) +
  geom_histogram(bins = 15,
                 color = NA, fill = "grey5") +
  scale_x_log10(labels = label_log()) +
  facet_grid(cols = vars(model)) +
  labs(x = "Size-normalized Sigma Value",
       y = "Number of Observations",
       title = "Distribution of Sigmas in CvTdb data") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        plot.title = element_text(hjust = 0.5),
        axis.ticks = element_blank(),
        axis.line = element_blank())

ggsave(paste0(Sys.getenv("FIG_DIR"),
              "NormalizedSigma_Distributions_2023-07.png"),
       height = 3, width = 5)
```


```{r update_eval_tkstats}
devtools::load_all()
my_pk <- readRDS("data-raw/all_cvt_pk.rds")
my_eval <- eval_tkstats(my_pk)

# To give summary RMSEs of Cmax and AUC...
my_eval <- my_eval %>%
  group_by(method, model, .add = TRUE) %>%
  ungroup(Reference) %>%
  summarize(AUC_inf_RMSE = sqrt((1/n())*(sum(AUC_inf.tkstats - AUC_inf.nca,
                                             na.rm = TRUE)^2)),
            Cmax_RMSE = sqrt((1/n())*(sum(Cmax.tkstats - Cmax.nca,
                                          na.rm = TRUE)^2)),
            .groups = "keep")

my_eval <- my_eval %>%
  mutate(dose_norm = TRUE,
         log10_norm = FALSE,
         scale_time = FALSE,
         Analysis_Type = "Pooled")


ggplot(my_eval,
       aes(x = AUC_inf_RMSE,
           y = Cmax_RMSE)) +
  geom_point() +
  geom_abline(slope = 1) +
  scale_y_log10() +
  scale_x_log10()

ggplot(my_eval,
       aes(x = -log10(AUC_inf_RMSE))) +
  geom_histogram(fill = "grey5") +
  facet_grid(cols = vars(method)) +
  labs(x = "Accuracy of AUC",
       y = "Observations") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        axis.ticks = element_blank(),
        axis.line = element_blank())


```


```{r eval_Joint}
my_pk2 <- readRDS("data-raw/all_cvt_pk_JOINT.rds")
my_eval_joint <- eval_tkstats(my_pk2)

# To give summary RMSEs of Cmax and AUC...
my_eval_joint <- my_eval_joint %>%
  group_by(method, model, .add = TRUE) %>%
  ungroup(Reference) %>%
  summarize(AUC_inf_RMSE = sqrt((1/n())*(sum(AUC_inf.tkstats - AUC_inf.nca,
                                             na.rm = TRUE)^2)),
            Cmax_RMSE = sqrt((1/n())*(sum(Cmax.tkstats - Cmax.nca,
                                          na.rm = TRUE)^2)),
            .groups = "keep")

my_eval_joint <- my_eval_joint %>%
  mutate(dose_norm = TRUE,
         log10_norm = FALSE,
         scale_time = FALSE,
         Analysis_Type = "Joint")


ggplot(my_eval_joint,
       aes(x = AUC_inf_RMSE,
           y = Cmax_RMSE)) +
  geom_point()

ggplot(my_eval_joint,
       aes(x = -log10(AUC_inf_RMSE))) +
  geom_histogram(fill = "grey5") +
  facet_grid(cols = vars(method)) +
  labs(x = "Accuracy of AUC",
       y = "Observations") +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        axis.ticks = element_blank(),
        axis.line = element_blank())


total_eval <- bind_rows(my_eval, my_eval_joint)

ggplot(total_eval,
       aes(x = AUC_inf_RMSE,
           y = Cmax_RMSE)) +
  geom_point() +
  facet_grid(rows = vars(Analysis_Type))

total_eval %>%
  dplyr::select(!Cmax_RMSE) %>%
  pivot_wider(names_from = Analysis_Type,
              values_from = AUC_inf_RMSE) %>%
  ggplot(aes(x = log10(Pooled),
             y = log10(Joint),
             color = Media)) +
  geom_point(alpha = 0.3) +
  geom_abline(slope = 1, linetype = "dashed") +
  facet_grid(rows = vars(model),
             cols = vars(method)) +
  theme(panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        axis.ticks = element_blank(),
        axis.line = element_blank())


total_eval %>%
  dplyr::select(!Cmax_RMSE) %>%
  pivot_wider(names_from = Analysis_Type,
              values_from = AUC_inf_RMSE) %>%
  mutate(ratio = Joint/Pooled) %>%
  # filter(!(ratio == 1)) %>% 
  # View()
  pull(Chemical) %>%
  # unique()
  length()

```



```{r PredictionVariability_overtime}
my_pk <- readRDS("data-raw/all_cvt_pk.rds")
winmodels <- AIC(my_pk) %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "L-BFGS-B") %>%
  ungroup() %>%
  dplyr::select(Chemical, Species,
                method, model)
my_preds <- inner_join(winmodels,
                       predict(my_pk,
                               use_scale_conc = TRUE))

my_tkstats <- inner_join(winmodels, get_tkstats(my_pk))
my_residuals <- residuals(my_pk, use_scale_conc = FALSE)


my_residuals %>%
  filter(exclude == FALSE) %>%
  inner_join(winmodels) %>%
  inner_join(my_tkstats %>%
              dplyr::select(Chemical, Species,
                            Route, Media,
                            tmax) %>%
              filter(!is.na(tmax))) %>%
  group_by(Chemical,
           Species,
           Route,
           Media,
           Dose) %>%
  mutate(
         normTime = ifelse(
           Route == "iv",
           1 + Time/max(Time),
           ifelse(
             Time > tmax,
             ((Time - tmax)/max(Time)) + 1,
             0.5 + Time/(2*tmax)
           )
         )) %>%
  distinct() %>%
  filter(Detect %in% TRUE) -> my_residuals2
my_residuals2 %>%
  # filter(Route == "oral") %>% View()
  ggplot(aes(
    x = normTime,
    y = Residuals
  )) +
  geom_point(alpha = 0.2, size = 0.5) +
  geom_point(data = filter(my_residuals2,
                           Chemical %in% "DTXSID4020533",
                           Species %in% "rat"),
             color = "orange2", size = 0.5) +
  geom_point(data = filter(my_residuals2,
                           Chemical %in% "DTXSID8031865",
                           Species %in% "rat"),
             color = "magenta4", size = 0.5) +
  geom_point(data = filter(my_residuals2,
                           Chemical %in% "DTXSID8025337",
                           Species %in% "rat"),
             color = "green2", size = 0.5) +
  geom_vline(xintercept = 1, color = "blue", linetype = "dashed") +
  geom_vline(xintercept = 2, color = "green4", linetype = "dashed") +
  facet_grid(cols = vars(Route),
             # rows = vars(model),
             scales = "free_x") +
  labs(x = "ADME-Normalized Time",
       y = "Winning Model Residuals") +
  theme(aspect.ratio = 1,
        panel.border = element_rect(color = "black", fill = NA, size = 1.5),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "grey90", linewidth = 0.5),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold"),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        axis.text.x = element_blank())

ggsave(paste0(Sys.getenv("FIG_DIR"),
              "ADME_NormalizedTime-WinModelResiduals_onlyDetects_Highlighted_2023-07-19.png"),
       height = 4,
       width = 6,
       units = "in")
```

```{r log10_Pooled}
devtools::load_all()

my_log10pk <- pk(data = cvt) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = FALSE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species)) 
# Add Reference for Joint Analysis

my_log10pk <- do_preprocess(my_log10pk)

my_log10pk <- do_data_info(my_log10pk)

my_log10pk <- do_prefit(my_log10pk)


my_log10pk <- do_fit(my_log10pk)
# saveRDS(my_log10pk, file = "data-raw/all_cvt_pklog10.rds")

my_AIC <- AIC(my_log10pk)
my_tkstats <- get_tkstats(my_log10pk)

my_AIC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "bobyqa") %>%
  ungroup() %>%
  count(model)
# model_1comp 69
# model_2comp 35
# model_flat   7

my_AIC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "L-BFGS-B") %>%
  ungroup() %>%
  count(model)
# model_1comp 77
# model_2comp 25
# model_flat   9

# To give summary RMSEs of Cmax and AUC...
my_eval <- eval_tkstats(my_log10pk) %>%
  group_by(method, model, .add = TRUE) %>%
  ungroup(Reference) %>%
  summarize(AUC_inf_RMSE = sqrt((1/n())*(sum(AUC_inf.tkstats - AUC_inf.nca,
                                             na.rm = TRUE)^2)),
            Cmax_RMSE = sqrt((1/n())*(sum(Cmax.tkstats - Cmax.nca,
                                          na.rm = TRUE)^2)),
            .groups = "keep")

my_eval %>%
  group_by(method) %>%
  summarize(AUC_meanRMSE = mean(AUC_inf_RMSE),
            AUC_mediRMSE = median(AUC_inf_RMSE),
            AUC_sdRMSE = sd(AUC_inf_RMSE),
            Cmax_meanRMSE = mean(Cmax_RMSE),
            Cmax_mediRMSE = median(Cmax_RMSE),
            Cmax_sdRMSE = sd(Cmax_RMSE)) %>% as.data.frame()

```

```{r log10_Joint}
my_log10pk <- pk(data = cvt) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = FALSE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = FALSE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species, Reference)) 
# Add Reference for Joint Analysis

my_log10pk <- do_preprocess(my_log10pk)

my_log10pk <- do_data_info(my_log10pk)

my_log10pk <- do_prefit(my_log10pk)


my_log10pk <- do_fit(my_log10pk)

my_AIC <- AIC(my_log10pk)

my_AIC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "bobyqa") %>%
  ungroup() %>%
  count(model)
# model_1comp 56
# model_2comp 54
# model_flat  1

my_AIC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "L-BFGS-B") %>%
  ungroup() %>%
  count(model)
# model_1comp 63
# model_2comp 48
# model_flat  0

my_eval <- eval_tkstats(my_log10pk)

# To give summary RMSEs of Cmax and AUC...
my_eval <- my_eval %>%
  group_by(method, model, .add = TRUE) %>%
  ungroup(Reference) %>%
  summarize(AUC_inf_RMSE = sqrt((1/n())*(sum(AUC_inf.tkstats - AUC_inf.nca,
                                             na.rm = TRUE)^2)),
            Cmax_RMSE = sqrt((1/n())*(sum(Cmax.tkstats - Cmax.nca,
                                          na.rm = TRUE)^2)),
            .groups = "keep")

my_eval %>%
  group_by(method) %>%
  summarize(AUC_meanRMSE = mean(AUC_inf_RMSE),
            AUC_mediRMSE = median(AUC_inf_RMSE),
            AUC_sdRMSE = sd(AUC_inf_RMSE),
            Cmax_meanRMSE = mean(Cmax_RMSE),
            Cmax_mediRMSE = median(Cmax_RMSE),
            Cmax_sdRMSE = sd(Cmax_RMSE)) %>%
  as.data.frame()


```

```{r boilerplate_RMSE_analysis}
my_pk <- readRDS("data-raw/all_cvt_pk.rds")
my_AIC <- AIC(my_pk)

my_AIC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "bobyqa") %>%
  ungroup() %>%
  count(model)

my_AIC %>% group_by(Chemical, Species, method) %>%
  filter(AIC == min(AIC),
         method == "L-BFGS-B") %>%
  ungroup() %>%
  count(model)

my_eval <- eval_tkstats(my_pk)

# To give summary RMSEs of Cmax and AUC...
my_eval <- my_eval %>%
  group_by(method, model, .add = TRUE) %>%
  ungroup(Reference) %>%
  summarize(AUC_inf_RMSE = sqrt((1/n())*(sum(AUC_inf.tkstats - AUC_inf.nca,
                                             na.rm = TRUE)^2)),
            Cmax_RMSE = sqrt((1/n())*(sum(Cmax.tkstats - Cmax.nca,
                                          na.rm = TRUE)^2)),
            .groups = "keep")

my_eval %>%
  group_by(method) %>%
  summarize(AUC_meanRMSE = mean(AUC_inf_RMSE),
            AUC_mediRMSE = median(AUC_inf_RMSE),
            AUC_sdRMSE = sd(AUC_inf_RMSE),
            Cmax_meanRMSE = mean(Cmax_RMSE),
            Cmax_mediRMSE = median(Cmax_RMSE),
            Cmax_sdRMSE = sd(Cmax_RMSE)) %>%
  as.data.frame()
```


```{r bad_fits}
predata_chemical <- my_pk$prefit$fit_check %>%
  filter(fit_decision == "abort") %>%
  pull(Chemical) %>%
  unique()

my_pk <- pk(data = cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% predata_chemical)) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species)) 
# Add Reference for Joint Analysis

my_pk <- do_preprocess(my_pk)

get_data(my_pk) %>% View()

plot(my_pk, print_out = TRUE)[[1]] +
  labs(subtitle = "Dibutyl phthalate (DBP)") +
  theme(aspect.ratio = 1,
        plot.subtitle = element_text(hjust = 0.5))
ggsave(paste0(Sys.getenv("FIG_DIR"),
              "DTXSID20211781_rat_badFit.png"),
       width = 6,
       height = 4,
       units = "in")

my_pk <- pk(data = cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% "DTXSID2021315")) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species)) 

my_pk <- do_fit(my_pk)

plot(my_pk,
     method = "L-BFGS-B",
     n_interp = 10,
     print_out = TRUE)[[1]] +
  labs(subtitle = "2,3,7,8-tetrachlorodibenzo-p-dioxin") +
  scale_x_continuous(breaks = c(0, (1:4)*(24*7*4)),
                     labels = c(0, 1:4),
                     name = "Time (months)") +
  guides(color = "none",
         shape = "none") +
  theme(aspect.ratio = 1,
        plot.subtitle = element_text(hjust = 0.5))
ggsave(paste0(Sys.getenv("FIG_DIR"),
              "DTXSID2021315_rat_badFit.png"),
       width = 8,
       height = 5,
       units = "in")



my_pk <- pk(data = cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% "DTXSID3032179")) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = FALSE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species)) 

my_pk <- do_fit(my_pk)

plot(my_pk,
     method = "L-BFGS-B",
     use_scale_conc = FALSE,
     log10_C = FALSE,
     n_interp = 50,
     print_out = TRUE)[[1]] +
  labs(subtitle = "3,3',4,4',5-pentachlorobiphenyl (without Dose-Normalized Fit)") +
  scale_x_continuous(breaks = c(0, (1:14)*(24*7*4)),
                     labels = c(0, 1:14),
                     name = "Time (months)") +
  guides(color = "none",
         shape = "none") +
  theme(aspect.ratio = 1,
        plot.subtitle = element_text(hjust = 0.5))
ggsave(paste0(Sys.getenv("FIG_DIR"),
              "DTXSID3032179_rat_badFit_noDoseNorm.png"),
       width = 7.5,
       height = 5,
       units = "in")

my_pk <- pk(data = cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% "DTXSID3032179")) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species)) 

my_pk <- do_fit(my_pk)

plot(my_pk,
     method = "L-BFGS-B",
     use_scale_conc = FALSE,
     log10_C = FALSE,
     n_interp = 50,
     print_out = TRUE)[[1]] +
  labs(subtitle = "3,3',4,4',5-pentachlorobiphenyl (Dose-Normalized Fit)") +
  scale_x_continuous(breaks = c(0, (1:14)*(24*7*4)),
                     labels = c(0, 1:14),
                     name = "Time (months)") +
  guides(color = "none",
         shape = "none") +
  theme(aspect.ratio = 1,
        plot.subtitle = element_text(hjust = 0.5))
ggsave(paste0(Sys.getenv("FIG_DIR"),
              "DTXSID3032179_rat_badFit_DoseNorm.png"),
       width = 7.5,
       height = 5,
       units = "in")


my_pk <- pk(data = cvt %>%
  dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% "DTXSID1034187")) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  # scale_time(new_units = "auto") +
  # stat_model() + 
  stat_error_model(error_group = vars(Chemical, Species)) 

my_pk <- do_fit(my_pk)

get_data(my_pk) %>% View()
plot(my_pk,
     method = "L-BFGS-B",
     use_scale_conc = TRUE,
     log10_C = FALSE,
     n_interp = 100,
     print_out = TRUE)[[1]] +
  labs(subtitle = "Tamoxifen") +
  theme(aspect.ratio = 1,
        plot.subtitle = element_text(hjust = 0.5))
ggsave(paste0(Sys.getenv("FIG_DIR"),
              "DTXSID1034187_rat_badFit_.png"),
       width = 7,
       height = 7,
       units = "in")
# Fit is actually ok, but there are lot's of non-Detects in the data
# There are many doses that are fully non-Detects.


problem_dose <- all_my_data %>%
  group_by(Chemical, Species, Route, Media, Dose) %>%
  filter(sum(Detect) == 0) %>%
  dplyr::select(Chemical, Species, Route, Media, Dose) %>%
  rename(chemicals_analyzed.dsstox_substance_id = Chemical,
         subjects.species_harmonized = Species,
         series.conc_medium_normalized = Media,
         studies.administration_route_normalized = Route,
         studies.dose_level_normalized_corrected = Dose) %>%
  distinct()

problem_dose_DTX <- all_my_data %>%
  group_by(Chemical, Species, Route, Media, Dose) %>%
  filter(sum(Detect) == 0) %>%
  ungroup() %>%
  pull(1) %>% unique()

# Figure out if the fits improve if we exclude Dose groups that do not have
# any Detects

my_pk_full <- pk(data = cvt %>%
                   dplyr::filter(chemicals_analyzed.dsstox_substance_id %in% 
                                   "DTXSID1034187")) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  stat_error_model(error_group = vars(Chemical, Species)) 

my_pk_full <- do_preprocess(my_pk_full)
my_pk_full <- do_fit(my_pk_full)

plot(my_pk_full,
     n_interp = 50,
     use_scale_conc = TRUE,
     print_out = TRUE)


my_pk_trimmed <- pk(data = cvt %>%
                      dplyr::filter(chemicals_analyzed.dsstox_substance_id %in%
                                      "DTXSID1034187") %>%
                      anti_join(problem_dose)) +
  facet_data(vars(Chemical, Species)) +
  settings_preprocess(keep_data_original = TRUE) +
  settings_optimx(method = c("L-BFGS-B", "bobyqa")) +
  scale_conc(dose_norm = TRUE, log10_trans = FALSE) +
  stat_error_model(error_group = vars(Chemical, Species)) 

my_pk_trimmed <- do_preprocess(my_pk_trimmed)
my_pk_trimmed <- do_fit(my_pk_trimmed)

AIC(my_pk_full) %>% View("full")
AIC(my_pk_trimmed) %>% View("trimmed")

get_winning_model(my_pk_full)
get_winning_model(my_pk_trimmed)

eval_tkstats(my_pk_full) %>% View("full_tkstats")
eval_tkstats(my_pk_trimmed) %>% View("trimmed_tkstats")
get_tkstats(my_pk_trimmed) %>% View()

plot(my_pk_trimmed,
     n_interp = 50,
     method = "L-BFGS-B",
     print_out = TRUE)

```


```{r function_connections}
fw <- mvbutils::foodweb(where = asNamespace("invivoPKfit"),
                        border = TRUE, cex = 0.6, lwd = 1.5)
fun_mat <- fw$funmat

mvbutils::foodweb(where = asNamespace("invivoPKfit"),
                  prune = "compare_models",
                  border = TRUE, cex = 1, lwd = 1.5)

fun_mat2 <- fun_mat[rowSums(fun_mat) > 0, ]

library(ComplexHeatmap)
ComplexHeatmap::Heatmap(fun_mat2, row_names_side = "left", column_names_side = "top",
                        row_names_gp = gpar(fontsize = 10),
                        column_names_gp = gpar(fontsize = 10),
                        col = circlize::colorRamp2(c(0, 1), colors = c("white", "green4")),
                        rect_gp = gpar(col = "black", lwd = 1),
                        show_row_dend = FALSE,
                        show_column_dend = FALSE)


fun_mat %>%
  as_tibble(rownames = NA) %>%
  rownames_to_column(var = "from") %>%
  pivot_longer(cols = !from,
               names_to = "to",
               values_to = "Call") %>%
   mutate(
    from = str_remove(from, pattern = ".pk"),
    to = str_remove(to, pattern = ".pk")
  ) %>%
  filter(from %in% "residuals") %>% View()

fun_mat2 %>%
  as_tibble(rownames = NA) %>%
  rownames_to_column(var = "from") %>%
  pivot_longer(cols = !from,
               names_to = "to",
               values_to = "Call") %>%
  filter(Call != 0) %>% 
  transmute(
    from = str_remove(from, pattern = ".pk"),
    to = str_remove(to, pattern = ".pk")
  ) %>%
  filter(from %in% c("residuals"),
         !(to %in% c("check_model",
                     "check_method",
                     "check_newdata",
                     "check_required_status"))) %>%
  ggflowchart::ggflowchart(horizontal = TRUE)



# Random Bits
# 
rmse(my_pk) %>%
  group_by(!!!my_pk$data_group, model, method, Route, Media, Dose) %>%
  mutate(avg_rmse = mean(RMSE)) %>%
  nest(full_rmse = c(Time, RMSE))

fold_errors(my_pk) %>%
  group_by(!!!my_pk$data_group, model, method, Route, Media, Dose) %>%
  mutate(avg_FoldErr = mean(Fold_Error),
         median_FoldErr = median(Fold_Error),
         within_2fold = sum(Fold_Error >= 0.5 & Fold_Error <= 2)/length(Fold_Error)) %>%
  dplyr::select(Time, Fold_Error, avg_FoldErr, median_FoldErr, within_2fold) %>%
  nest(full_fold_errors = c(Time, Fold_Error))


```

```{r questions}
my_pk <- readRDS("data-raw/all_cvt_pk.rds")


pk_summary <- summary(my_pk)


# Q: What do "bad" fits have in common?
gof_df <- pk_summary$goodness_of_fit %>%
  inner_join(suppressMessages(get_winning_model(my_pk))) %>%
  filter(method == "L-BFGS-B") %>%
  ungroup()

## Find the within_2fold for each data_group
gof_df %>%
  dplyr::select(Chemical, Species, full_fold_errors) %>%
  unnest(full_fold_errors) %>%
  group_by(Chemical, Species) %>%
  summarize(within_2fold = sum(
    Fold_Error >= 0.5 & Fold_Error <= 2, na.rm = TRUE
    ) / length(na.omit(Fold_Error))) %>%
  filter(within_2fold == 0) %>% pull(Chemical) %>% unique()
  arrange(within_2fold) %>%
  View()
  
gof_df %>%
  ggplot(aes(
    x = log2(avg_FoldErr),
    y = log10(avg_rmse))) +
  geom_point() +
  geom_vline(color = "red3", xintercept = c(-1, 1))


fe_df <- fold_errors(my_pk)
# Something wrong with the summary method... maybe only use detects?
fold_errors_all <- fe_df %>%
  inner_join(suppressMessages(get_winning_model(my_pk))) %>%
  dplyr::filter(Detect %in% TRUE) %>%
  dplyr::group_by(!!!my_pk$data_group, model, method, Route, Media, Dose) %>%
  dplyr::mutate(avg_FoldErr = mean(Fold_Error, na.rm = TRUE),
                median_FoldErr = median(Fold_Error, na.rm = TRUE),
                within_2fold = sum(Fold_Error >= 0.5 & Fold_Error <= 2)/length(Fold_Error)) %>%
  dplyr::select(Time, Fold_Error,
                avg_FoldErr, median_FoldErr, within_2fold) %>%
  tidyr::nest(full_fold_errors = c(Time, Fold_Error))
  

fold_errors_all %>% 
  ggplot(aes(x = within_2fold)) +
  geom_histogram(binwidth = 0.1) +
  facet_grid(cols = vars(model))

fe_df %>%
  inner_join(suppressMessages(get_winning_model(my_pk))) %>%
  dplyr::filter(Detect %in% TRUE) %>%
  ggplot(aes(x = log2(Fold_Error))) +
  xlim(-4, 4) +
  geom_histogram(binwidth = 0.1) +
  facet_grid(cols = vars(model))
  
# Q: What do "great" fits have in common?


# Q: Does the dataset have a bias?
```

